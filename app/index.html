<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>myKravings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alan+Sans:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-red: #D7262D;
            --primary-yellow: #FFC107;
            --bg-white: #FFFFFF;
            --bg-off-white: #F5F5F5;
            --text-dark: #222222;
        }
        
        body {
            font-family: 'Alan Sans', sans-serif;
            background-color: var(--bg-off-white);
        }
        
        #app-container {
            background-color: var(--bg-white);
            color: var(--text-dark);
            position: relative;
            overflow: hidden;
        }

        @keyframes pulse-fade-in {
            0% { opacity: 0; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes text-fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- UI Elements with Animations --- */
        .cool-button {
            background-color: var(--primary-red);
            border: 1px solid var(--primary-red);
            color: var(--bg-white);
            padding: 0.75rem;
            text-transform: uppercase;
            font-weight: 700;
            text-align: center;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            border-radius: 9999px; /* Rounded buttons */
        }
        .cool-button .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background-color: rgba(255, 255, 255, 0.3);
            transition: width 0.5s ease-out;
            z-index: 1;
        }
        .cool-button .button-text {
            position: relative;
            z-index: 2;
        }
        .cool-button:hover {
            opacity: 0.9;
        }
         .cool-button:disabled {
            opacity: 0.7;
        }

        .cool-input, .cool-select {
            background-color: var(--bg-off-white);
            border: 1px solid #e0e0e0;
            padding: 0.75rem 1rem;
            width: 100%;
            color: var(--text-dark);
            border-radius: 9999px;
            transition: border-color 0.2s;
        }
        .cool-input:focus, .cool-select:focus {
            outline: none;
            border-color: var(--primary-yellow);
        }
        .cool-input::placeholder { color: #9e9e9e; }
        .cool-select {
             -webkit-appearance: none; -moz-appearance: none; appearance: none;
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%23222222' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8l4 4l4-4'/%3E%3C/svg%3E");
             background-position: right 1rem center;
             background-repeat: no-repeat;
             background-size: 1.5em 1.5em;
        }
        
        /* --- Page & Modal Transitions --- */
        .page, .modal {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        .page.hidden, .modal.hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }
        .modal .modal-content {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal.hidden .modal-content {
            transform: translateY(100%);
        }
        
        /* Hide scrollbars */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden">

    <div id="app-container" class="relative h-full w-full max-w-md mx-auto">

        <!-- Splash Screen -->
        <div id="splash-screen" class="page absolute inset-0 z-50 flex flex-col items-center justify-center p-6 text-center bg-red-600">
            <img id="splash-logo" src="kravings.png" alt="myKravings Logo" class="h-24 w-24 mb-4 opacity-0">
            <h1 id="splash-title" class="text-4xl text-white font-black tracking-wide opacity-0" data-text="MYKRAVINGS">MYKRAVINGS</h1>
            <p id="splash-tagline" class="text-sm text-yellow-300 mt-2 opacity-0">Your Hostel's Craving Exchange</p>
            
            <div id="splash-loader" class="w-full absolute bottom-10 left-0 px-6 opacity-0">
                 <div id="splash-progress-container" class="w-full h-1.5 bg-red-400 rounded-full">
                    <div id="splash-progress-bar" class="h-full bg-white rounded-full" style="width: 0%; transition: width 0.5s ease;"></div>
                 </div>
                 <p id="splash-status" class="text-xs text-white mt-2 h-4 text-center"></p>
            </div>
        </div>

        <!-- Login/Signup Pages -->
        <div id="login-page" class="page absolute inset-0 z-40 p-6 flex flex-col justify-center hidden">
            <h2 class="text-4xl font-black text-center mb-8 text-red-600">> LOGIN_</h2>
            <input id="login-email" type="email" placeholder="Email" class="cool-input mb-4">
            <input id="login-password" type="password" placeholder="Password" class="cool-input mb-4">
            <button id="login-btn" class="cool-button"><span class="button-text">Log In</span><span class="progress-bar"></span></button>
            <p class="text-center text-sm mt-4">New here? <a href="#" id="show-signup-page-btn" class="text-red-600 font-bold hover:underline">Register</a></p>
        </div>
        <div id="signup-page" class="page absolute inset-0 z-40 p-6 flex flex-col justify-center hidden">
            <h2 class="text-4xl font-black text-center mb-8 text-red-600">> REGISTER_</h2>
            <input id="signup-name" type="text" placeholder="Name" class="cool-input mb-4">
            <input id="signup-room" type="text" placeholder="Room ID" class="cool-input mb-4">
            <input id="signup-email" type="email" placeholder="Email" class="cool-input mb-4">
            <input id="signup-password" type="password" placeholder="Password" class="cool-input mb-4">
            <button id="signup-btn" class="cool-button"><span class="button-text">Create Account</span><span class="progress-bar"></span></button>
            <p class="text-center text-sm mt-4">Have an account? <a href="#" id="show-login-page-btn" class="text-red-600 font-bold hover:underline">Log In</a></p>
        </div>

        <!-- Onboarding -->
        <div id="college-select-page" class="page absolute inset-0 z-30 p-6 flex flex-col justify-center hidden">
            <h2 class="text-3xl font-black mb-4">> Select College</h2>
            <select id="college-name-select" class="cool-select mb-4">
                <option value="" disabled selected>-- Select --</option>
                <option value="SRM AP">SRM AP</option>
                <option value="VIT">VIT</option>
            </select>
            <button id="submit-college-btn" class="cool-button"><span class="button-text">Next</span><span class="progress-bar"></span></button>
        </div>
        <div id="hostel-select-page" class="page absolute inset-0 z-20 p-6 flex flex-col hidden">
             <h2 class="text-3xl font-black mb-4">> Select Hostel</h2>
             <p id="hostel-prompt-college" class="text-sm text-gray-500 mb-4">Select your hostel.</p>
             <ul id="hostel-list" class="space-y-2"></ul>
        </div>

        <!-- Main App -->
        <div id="main-app" class="page absolute inset-0 z-10 flex flex-col h-full hidden">
            <header class="p-4 border-b border-gray-200 flex flex-col items-center text-center bg-white">
                <h1 class="text-2xl font-black tracking-wide text-red-600">MYKRAVINGS</h1>
                <div class="flex items-center space-x-2 mt-2 text-xs">
                    <span class="text-gray-500">Location:</span>
                    <div class="px-3 py-1 bg-yellow-300 rounded-full">
                         <p id="hostel-name-header" class="font-bold text-yellow-800"></p>
                    </div>
                </div>
            </header>
            <main id="main-content" class="flex-1 overflow-y-auto p-4 no-scrollbar pb-24 bg-gray-50">
                <div id="home-tab">
                    <div id="snack-grid" class="grid grid-cols-2 gap-4"></div>
                </div>
                <div id="profile-tab" class="hidden">
                    <h2 class="text-2xl font-black mb-4">> My Profile</h2>
                    <div class="border border-gray-200 p-4 space-y-1 text-sm bg-white rounded-lg">
                        <p id="profile-user-name"><strong>Name:</strong> N/A</p>
                        <p id="profile-user-college"><strong>College:</strong> N/A</p>
                        <p id="profile-hostel-name"><strong>Hostel:</strong> N/A</p>
                    </div>
                    <button id="logout-btn" class="w-full mt-4 cool-button"><span class="button-text">Logout</span><span class="progress-bar"></span></button>
                    <h3 class="text-2xl font-black mt-6 mb-3">> My Items</h3>
                    <div id="my-listed-snacks" class="space-y-3"></div>
                </div>
            </main>
            <nav class="absolute bottom-0 left-0 right-0 h-16 border-t border-gray-200 flex items-center justify-around text-xs uppercase font-medium bg-white z-10">
                <button data-tab="home-tab" class="nav-btn flex flex-col items-center gap-1 text-red-600">
                    <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    <span>FEED</span>
                </button>
                <button id="open-exchange-modal-btn" class="h-14 w-14 bg-red-600 text-white rounded-full text-3xl flex items-center justify-center transform -translate-y-4 shadow-lg">+</button>
                <button data-tab="profile-tab" class="nav-btn flex flex-col items-center gap-1 text-gray-500">
                    <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    <span>USER</span>
                </button>
            </nav>
        </div>

        <!-- Modals -->
        <div id="exchange-modal" class="modal fixed inset-0 z-50 flex items-end justify-center hidden">
            <div class="modal-bg absolute inset-0 bg-black/50"></div>
            <div class="modal-content relative z-10 bg-white w-full max-w-md p-6 rounded-t-2xl">
                <h2 class="text-2xl font-black text-center mb-4">> List Your Snack Exchange</h2>
                <label for="snack-photo-upload" class="cursor-pointer">
                    <div id="snack-photo-preview" class="h-32 w-full border-2 border-dashed border-gray-300 flex items-center justify-center mb-4 text-xs text-center p-2 bg-gray-50 rounded-lg">Tap to use camera</div>
                </label>
                <input id="snack-photo-upload" type="file" accept="image/*" capture="environment" class="hidden">
                <input id="snack-name-input" type="text" placeholder="Item Name" class="cool-input mb-4">
                <div class="flex space-x-4 mb-4 text-sm">
                    <label class="flex-1"><input type="radio" name="listingType" value="Barter" class="mr-2" checked>Snack Exchange</label>
                    <label class="flex-1"><input type="radio" name="listingType" value="Price" class="mr-2">Price</label>
                </div>
                <input id="snack-price-input" type="number" placeholder="Price (₹)" class="cool-input mb-4 hidden">
                <button id="list-snack-btn" class="cool-button w-full"><span class="button-text">List Item</span><span class="progress-bar"></span></button>
                <button id="close-exchange-modal-btn" class="absolute top-4 right-4 text-2xl text-gray-500">&times;</button>
            </div>
        </div>
        <div id="snack-detail-page" class="page absolute inset-0 z-30 bg-white p-6 flex flex-col hidden">
             <button id="close-detail-page-btn" class="absolute top-4 left-4 text-sm text-red-600 z-10 font-bold hover:underline">&lt; BACK</button>
             <div id="snack-detail-content" class="flex-1 overflow-y-auto no-scrollbar pt-8"></div>
        </div>
        <div id="bid-accepted-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
            <div class="modal-bg absolute inset-0 bg-black/50"></div>
            <div class="modal-content relative z-10 bg-white w-full max-w-sm p-6 rounded-2xl text-center">
                 <h2 class="text-2xl font-black text-green-500 mb-2">> Trade Confirmed!</h2>
                 <p class="text-sm mb-4 text-gray-600">Contact Info:</p>
                 <div id="contact-info" class="bg-gray-100 p-4 rounded-lg text-left text-sm"></div>
                 <button id="close-bid-accepted-modal-btn" class="mt-4 w-full cool-button"><span class="button-text">OK</span><span class="progress-bar"></span></button>
            </div>
        </div>

        <div id="toast-notification" class="absolute bottom-20 left-1/2 -translate-x-1/2 px-4 py-2 text-sm text-white rounded-full transition-all duration-300 opacity-0 -translate-y-4 pointer-events-none z-50"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, query, where, serverTimestamp, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- FIREBASE SETUP ---
            const firebaseConfig = {
              apiKey: "AIzaSyA2dmDva2fu3RDtj7wr2CFh8UPDS4pfdDo",
              authDomain: "karvings-4c80d.firebaseapp.com",
              projectId: "karvings-4c80d",
              storageBucket: "karvings-4c80d.appspot.com",
              messagingSenderId: "164212138890",
              appId: "1:164212138890:web:a6c85d9b0fe4ab506ede73"
            };
            const appId = 'karvings-4c80d';
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // --- GLOBAL STATE ---
            let currentUser = null;
            let userProfile = null;
            const collegeHostels = { "SRM AP": ["GANGA", "VEDAVATHI"], "VIT": ["BH-1 (BOYS)", "BH-2 (BOYS)", "GH-1 (GIRLS)"] };

            // --- UI & ANIMATION HELPERS ---
            let toastTimeout;
            const showToast = (message, isError = false) => {
                const toast = document.getElementById('toast-notification');
                toast.textContent = message;
                toast.style.backgroundColor = isError ? '#D7262D' : '#4CAF50';
                toast.classList.remove('opacity-0', '-translate-y-4');
                toast.classList.add('opacity-100', 'translate-y-0');
                clearTimeout(toastTimeout);
                toastTimeout = setTimeout(() => {
                    toast.classList.add('opacity-0', '-translate-y-4');
                }, 3000);
            };

            const pages = document.querySelectorAll('.page');
            const navigateTo = (pageId) => {
                pages.forEach(page => page.classList.add('hidden'));
                document.getElementById(pageId)?.classList.remove('hidden');
            };

            const simulateProgress = async (button) => {
                if(!button) return;
                const progressBar = button.querySelector('.progress-bar');
                if(!progressBar) return;
                button.classList.add('processing');
                button.disabled = true;
                
                let width = 0;
                await new Promise(resolve => {
                    const interval = setInterval(() => {
                        width += 20;
                        progressBar.style.width = `${width}%`;
                        if (width >= 100) {
                            clearInterval(interval);
                            resolve();
                        }
                    }, 100);
                });
                
                await new Promise(res => setTimeout(res, 200));

                progressBar.style.width = '0%';
                button.classList.remove('processing');
                button.disabled = false;
            };

            // --- IMAGE RESIZE HELPER ---
            const resizeAndEncodeImage = (file, maxSize = 400) => {
                return new Promise((resolve, reject) => {
                    if (!file.type.startsWith('image/')) {
                        return reject(new Error('File is not an image.'));
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > maxSize) {
                                    height *= maxSize / width;
                                    width = maxSize;
                                }
                            } else {
                                if (height > maxSize) {
                                    width *= maxSize / height;
                                    height = maxSize;
                                }
                            }

                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                            resolve(dataUrl);
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };


            // --- SPLASH SCREEN ANIMATION ---
            const runSplashScreen = () => {
                const logo = document.getElementById('splash-logo');
                const title = document.getElementById('splash-title');
                const tagline = document.getElementById('splash-tagline');
                const loader = document.getElementById('splash-loader');
                const progressBar = document.getElementById('splash-progress-bar');
                const statusEl = document.getElementById('splash-status');

                logo.style.animation = 'pulse-fade-in 1s forwards';
                
                setTimeout(() => {
                    title.style.animation = 'text-fade-in 0.5s forwards';
                }, 600);
                
                setTimeout(() => {
                    tagline.style.animation = 'text-fade-in 0.5s forwards';
                }, 1100);

                setTimeout(() => {
                    loader.style.animation = 'text-fade-in 0.5s forwards';
                    
                    const bootLines = ["Connecting...", "Authenticating...", "Loading Feed...", "Ready."];
                    let lineIndex = 0;
                    let progress = 0;
                    const interval = setInterval(() => {
                        if (lineIndex < bootLines.length) {
                            statusEl.textContent = bootLines[lineIndex];
                            lineIndex++;
                        }
                        progress += 25;
                        progressBar.style.width = `${progress}%`;

                        if (progress >= 100) {
                            clearInterval(interval);
                            statusEl.textContent = "Welcome!";
                        }
                    }, 800);
                }, 1600);
            };

            // --- APP INITIALIZATION ---
            runSplashScreen();
            setTimeout(() => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        const userDoc = await getDoc(doc(db, `/artifacts/${appId}/public/data/users`, user.uid));
                        if (userDoc.exists()) {
                            userProfile = userDoc.data();
                            if (userProfile.college && userProfile.hostel) {
                                setupMainApp(userProfile.college, userProfile.hostel);
                            } else navigateTo('college-select-page');
                        } else navigateTo('college-select-page');
                    } else {
                        currentUser = null; userProfile = null; navigateTo('login-page');
                    }
                });
            }, 4800);

            // --- EVENT LISTENERS ---
            document.getElementById('show-signup-page-btn').addEventListener('click', (e) => { e.preventDefault(); navigateTo('signup-page'); });
            document.getElementById('show-login-page-btn').addEventListener('click', (e) => { e.preventDefault(); navigateTo('login-page'); });
            
            document.getElementById('signup-btn').addEventListener('click', async (e) => {
                simulateProgress(e.currentTarget);
                const name = document.getElementById('signup-name').value;
                const room = document.getElementById('signup-room').value;
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                if (!name || !room || !email || !password) { showToast("All fields are required.", true); return; }
                try {
                    const cred = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, `/artifacts/${appId}/public/data/users`, cred.user.uid), { name, room, email, college: null, hostel: null });
                } catch (e) { showToast(`Error: ${e.code}`, true); }
            });

            document.getElementById('login-btn').addEventListener('click', async (e) => {
                simulateProgress(e.currentTarget);
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if (!email || !password) { showToast("Credentials are required.", true); return; }
                try { await signInWithEmailAndPassword(auth, email, password); } 
                catch (e) { showToast(`Error: ${e.code}`, true); }
            });

            document.getElementById('logout-btn').addEventListener('click', async (e) => {
                simulateProgress(e.currentTarget);
                try { await signOut(auth); navigateTo('login-page'); } 
                catch (e) { showToast(`Error: ${e.code}`, true); }
            });
            
            document.getElementById('submit-college-btn').addEventListener('click', (e) => {
                simulateProgress(e.currentTarget);
                const college = document.getElementById('college-name-select').value;
                if (!college) { showToast("Please select a college.", true); return; }
                populateHostels(college);
                navigateTo('hostel-select-page');
            });

            // --- APP LOGIC ---
            const populateHostels = (collegeName) => {
                const list = document.getElementById('hostel-list');
                document.getElementById('hostel-prompt-college').textContent = `College: ${collegeName}`;
                list.innerHTML = '';
                (collegeHostels[collegeName] || []).forEach(name => {
                    const li = document.createElement('li');
                    li.className = 'cool-button';
                    li.innerHTML = `<span class="button-text">${name}</span><span class="progress-bar"></span>`;
                    li.addEventListener('click', async (e) => {
                        simulateProgress(e.currentTarget);
                        await setDoc(doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid), { college: collegeName, hostel: name }, { merge: true });
                        userProfile.college = collegeName; userProfile.hostel = name;
                        setupMainApp(collegeName, name);
                    });
                    list.appendChild(li);
                });
            };

            const setupMainApp = (college, hostel) => {
                document.getElementById('hostel-name-header').textContent = hostel;
                document.getElementById('profile-user-name').textContent = `Name: ${userProfile.name}`;
                document.getElementById('profile-user-college').textContent = `College: ${college}`;
                document.getElementById('profile-hostel-name').textContent = `Hostel: ${hostel}`;
                listenForSnacks(hostel);
                navigateTo('main-app');
            };

            let unsubSnacks = null;
            const listenForSnacks = (hostel) => {
                if (unsubSnacks) unsubSnacks();
                const grid = document.getElementById('snack-grid');
                const q = query(collection(db, `/artifacts/${appId}/public/data/snacks`), where("hostel", "==", hostel));
                unsubSnacks = onSnapshot(q, (snapshot) => {
                    grid.innerHTML = snapshot.empty ? '<p class="col-span-2 text-center text-sm text-gray-500">No snacks offered yet.</p>' : '';
                    snapshot.forEach(d => {
                        const snack = d.data();
                        if(snack.status === 'exchanged') return;
                        const card = document.createElement('div');
                        card.className = 'bg-white rounded-lg shadow-md overflow-hidden transition-all hover:shadow-xl hover:transform hover:-translate-y-1';
                        card.innerHTML = `<img src="${snack.image}" class="w-full h-32 object-cover"><div class="p-3"><h3 class="font-bold truncate">${snack.name}</h3><p class="text-sm font-bold ${snack.type === 'Barter' ? 'text-blue-500' : 'text-green-600'}">${snack.type === 'Barter' ? 'SNACK EXCHANGE' : `₹${snack.price}`}</p></div>`;
                        card.addEventListener('click', () => showSnackDetail(d.id));
                        grid.appendChild(card);
                    });
                });
            };

            const navBtns = document.querySelectorAll('.nav-btn');
            const tabs = [document.getElementById('home-tab'), document.getElementById('profile-tab')];
            navBtns.forEach(btn => btn.addEventListener('click', () => {
                navBtns.forEach(b => b.classList.replace('text-red-600', 'text-gray-500'));
                btn.classList.replace('text-gray-500', 'text-red-600');
                const tabId = btn.dataset.tab;
                tabs.forEach(t => t.classList.add('hidden'));
                document.getElementById(tabId)?.classList.remove('hidden');
                if (tabId === 'profile-tab') listenForMyListedSnacks();
            }));

            const modal = document.getElementById('exchange-modal');
            const listBtn = document.getElementById('list-snack-btn');
            document.getElementById('open-exchange-modal-btn').addEventListener('click', () => modal.classList.remove('hidden'));
            document.getElementById('close-exchange-modal-btn').addEventListener('click', () => modal.classList.add('hidden'));
            modal.querySelector('.modal-bg').addEventListener('click', () => modal.classList.add('hidden'));
            
            document.querySelectorAll('input[name="listingType"]').forEach(r => r.addEventListener('change', (e) => {
                document.getElementById('snack-price-input').classList.toggle('hidden', e.target.value !== 'Price');
            }));
            
            document.getElementById('snack-photo-preview').addEventListener('click', function() {
                document.getElementById('snack-photo-upload').click();
            });

            document.getElementById('snack-photo-upload').addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const preview = document.getElementById('snack-photo-preview');
                        preview.style.backgroundImage = `url(${event.target.result})`;
                        preview.style.backgroundSize = 'cover';
                        preview.textContent = '';
                    }
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            listBtn.addEventListener('click', async (e) => {
                const name = document.getElementById('snack-name-input').value;
                const type = document.querySelector('input[name="listingType"]:checked').value;
                const price = document.getElementById('snack-price-input').value;
                const file = document.getElementById('snack-photo-upload').files[0];
                let priceVal = null;
                if (type === 'Price') {
                    if (!price) { showToast("Price is required.", true); return; }
                    priceVal = parseInt(price);
                    if (isNaN(priceVal) || priceVal < 0) { showToast("Invalid price.", true); return; }
                }
                if (!name || !file) { showToast("Name & image are required.", true); return; }
                await simulateProgress(e.currentTarget);
                try {
                    const imageDataUrl = await resizeAndEncodeImage(file);
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/snacks`), {
                        ownerId: currentUser.uid, ownerName: userProfile.name, room: userProfile.room,
                        name, type, price: priceVal, image: imageDataUrl,
                        college: userProfile.college, hostel: userProfile.hostel,
                        createdAt: serverTimestamp(), status: 'available'
                    });
                    modal.classList.add('hidden');
                    document.getElementById('snack-name-input').value = '';
                    document.getElementById('snack-price-input').value = '';
                    document.getElementById('snack-photo-upload').value = '';
                    const preview = document.getElementById('snack-photo-preview');
                    preview.style.backgroundImage = 'none'; preview.textContent = 'Tap to use camera';
                    showToast("Item listed!");
                } catch (err) {
                    console.error(err);
                    showToast(`Error: ${err.message}`, true);
                }
            });

            let currentSnackUnsub = null;
            const showSnackDetail = (id) => {
                if (currentSnackUnsub) currentSnackUnsub(); 
                 currentSnackUnsub = onSnapshot(doc(db, `/artifacts/${appId}/public/data/snacks`, id), (d) => {
                    if(!d.exists()) { navigateTo('main-app'); return; }
                    const snack = d.data();
                    const content = document.getElementById('snack-detail-content');
                    content.innerHTML = `<img src="${snack.image}" class="w-full h-64 object-cover rounded-lg mb-4"><h2 class="text-3xl font-black">${snack.name}</h2><p class="text-sm text-gray-500 mb-2">From: ${snack.ownerName} (${snack.room})</p><p class="text-lg mb-6 font-bold ${snack.type === 'Barter' ? 'text-blue-500' : 'text-green-600'}">${snack.type === 'Barter' ? 'SNACK EXCHANGE' : `₹${snack.price}`}</p>${snack.ownerId !== currentUser.uid ? `<div class="border border-gray-200 p-4 rounded-lg"><h3 class="text-xl font-bold mb-3">> Propose Trade</h3><label class="cursor-pointer"><div id="bid-photo-preview" class="h-24 w-full bg-gray-50 border-2 border-dashed border-gray-300 flex items-center justify-center mb-3 text-xs text-center p-2 rounded-lg">Use camera for bid</div></label><input id="bid-photo-upload" type="file" accept="image/*" capture="environment" class="hidden"><input id="bid-snack-name" type="text" placeholder="Your item's name" class="cool-input mb-3"><button id="submit-bid-btn" data-snack-id="${id}" class="cool-button w-full"><span class="button-text">Submit Bid</span><span class="progress-bar"></span></button></div>` : '<p class="text-center text-sm text-gray-500">// This is your listing.</p>'}`;
                 });
                 navigateTo('snack-detail-page');
            };
            
            document.getElementById('snack-detail-content').addEventListener('change', e => {
                if (e.target.id === 'bid-photo-upload' && e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const preview = document.getElementById('bid-photo-preview');
                        preview.style.backgroundImage = `url(${event.target.result})`;
                        preview.style.backgroundSize = 'cover'; preview.textContent = '';
                    }
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            document.getElementById('snack-detail-content').addEventListener('click', async e => {
                if (e.target.id === 'bid-photo-preview') {
                    document.getElementById('bid-photo-upload')?.click();
                }
                if (e.target.id === 'submit-bid-btn') {
                    const btn = e.target;
                    await simulateProgress(btn);
                    const id = btn.dataset.snackId;
                    const name = document.getElementById('bid-snack-name').value;
                    const file = document.getElementById('bid-photo-upload').files[0];
                    if (!name || !file) { showToast('Name & image are required.', true); return; }
                    try {
                        const imageDataUrl = await resizeAndEncodeImage(file);
                        await addDoc(collection(db, `/artifacts/${appId}/public/data/snacks`, id, 'bids'), {
                            bidderId: currentUser.uid, bidderName: userProfile.name, bidderRoom: userProfile.room,
                            snackName: name, snackImage: imageDataUrl, createdAt: serverTimestamp()
                        });
                        showToast('Bid submitted!'); navigateTo('main-app');
                    } catch (err) {
                        showToast(`Error: ${err.message}`, true);
                    }
                 }
            });

            document.getElementById('close-detail-page-btn').addEventListener('click', () => {
                if (currentSnackUnsub) currentSnackUnsub(); navigateTo('main-app');
            });

            let mySnacksUnsubs = [];
            const listenForMyListedSnacks = () => {
                mySnacksUnsubs.forEach(unsub => unsub()); mySnacksUnsubs = [];
                const container = document.getElementById('my-listed-snacks');
                const q = query(collection(db, `/artifacts/${appId}/public/data/snacks`), where("ownerId", "==", currentUser.uid));
                const snacksUnsub = onSnapshot(q, (snap) => {
                    container.innerHTML = snap.empty ? '<p class="text-xs text-center text-gray-500">// No items listed.</p>' : '';
                    snap.forEach(d => {
                        const snack = d.data(), id = d.id;
                        const div = document.createElement('div');
                        div.className = 'border border-gray-200 p-3 bg-white rounded-lg';
                        const status = snack.status === 'exchanged' ? `<p class="text-xs text-green-600 mt-1 font-bold">// TRADED WITH ${snack.exchangedWith.bidderName}</p>` : '';
                        div.innerHTML = `<p class="font-bold text-sm">${snack.name}</p>${status}<div class="bids-container mt-2" id="bids-for-${id}"><p class="text-xs text-gray-400">// Loading bids...</p></div>`;
                        container.appendChild(div);
                        if (snack.status !== 'exchanged') {
                            const bidsContainer = document.getElementById(`bids-for-${id}`);
                            const bidsUnsub = onSnapshot(query(collection(db, `/artifacts/${appId}/public/data/snacks`, id, 'bids')), (bidsSnap) => {
                                bidsContainer.innerHTML = bidsSnap.empty ? '<p class="text-xs text-gray-400">// NO BIDS</p>' : bidsSnap.docs.map(bidDoc => {
                                    const bid = bidDoc.data(), bidId = bidDoc.id;
                                    return `<div class="flex items-center justify-between mt-2 p-2 bg-gray-50 rounded-md"><div class="flex items-center min-w-0"><img src="${bid.snackImage}" class="w-8 h-8 rounded-md mr-2 object-cover"><div class="min-w-0 text-xs"><p class="font-bold truncate">${bid.snackName}</p><p class="truncate text-gray-500">From: ${bid.bidderName}</p></div></div><button class="accept-bid-btn text-xs bg-green-500 text-white px-2 py-1 rounded-md" data-snack-id="${id}" data-bid-id="${bidId}">ACCEPT</button></div>`;
                                }).join('');
                            });
                            mySnacksUnsubs.push(bidsUnsub);
                        }
                    });
                });
                mySnacksUnsubs.push(snacksUnsub);
            };
            
            document.getElementById('my-listed-snacks').addEventListener('click', async e => {
                if (e.target.classList.contains('accept-bid-btn')) {
                    const sId = e.target.dataset.snackId, bId = e.target.dataset.bidId;
                    const sRef = doc(db, `/artifacts/${appId}/public/data/snacks`, sId);
                    const bRef = doc(db, `/artifacts/${appId}/public/data/snacks`, sId, 'bids', bId);
                    const sDoc = await getDoc(sRef), bDoc = await getDoc(bRef);
                    if(sDoc.exists() && bDoc.exists()){
                        await updateDoc(sRef, { status: 'exchanged', exchangedWith: bDoc.data() });
                        showBidAcceptedModal(sDoc.data(), bDoc.data());
                    }
                }
            });

            const bidModal = document.getElementById('bid-accepted-modal');
            const showBidAcceptedModal = (snack, bid) => {
                document.getElementById('contact-info').innerHTML = `<p><strong>Lister:</strong> ${snack.ownerName} (${snack.room})</p><p><strong>Bidder:</strong> ${bid.bidderName} (${bid.bidderRoom})</p>`;
                bidModal.classList.remove('hidden');
            };
            document.getElementById('close-bid-accepted-modal-btn').addEventListener('click', () => bidModal.classList.add('hidden'));
        });
    </script>
</body>
</html>

