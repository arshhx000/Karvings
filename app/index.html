<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>myKravings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain; /* Prevents pull-to-refresh */
        }
        /* Hide scrollbars */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Simple page transition */
        .page {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .page.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        .modal-bg {
             transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        .modal.hidden .modal-bg {
            opacity: 0;
        }
        .modal.hidden .modal-content {
            transform: translateY(100%);
        }
    </style>
</head>
<body class="bg-gray-50 h-screen w-screen overflow-hidden">

    <!-- App Container -->
    <div id="app-container" class="relative h-full w-full max-w-md mx-auto bg-white shadow-lg">

        <!-- Splash Screen -->
        <div id="splash-screen" class="page absolute inset-0 z-50 flex flex-col items-center justify-center bg-amber-400 text-white">
            <img src="app/kravings.png" alt="myKravings Logo" class="h-24 w-24">
            <h1 class="text-4xl font-bold mt-4">myKravings</h1>
            <p class="mt-2 text-lg">Your Hostel's Craving Exchange</p>
        </div>

        <!-- Login Page -->
        <div id="login-page" class="page absolute inset-0 z-40 p-8 flex flex-col justify-center bg-gray-50 hidden">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Welcome Back!</h2>
            <input id="login-email" type="email" placeholder="Email" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:outline-none">
            <input id="login-password" type="password" placeholder="Password" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:outline-none">
            <button id="login-btn" class="w-full p-3 bg-amber-400 text-white font-bold rounded-lg hover:bg-amber-500 transition-colors">Log In</button>
            <p class="text-center text-gray-500 mt-4">Don't have an account? <a href="#" id="show-signup-page-btn" class="text-amber-500 font-semibold">Sign Up</a></p>
        </div>

        <!-- Signup Page -->
        <div id="signup-page" class="page absolute inset-0 z-40 p-8 flex flex-col justify-center bg-gray-50 hidden">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Create Account</h2>
            <input id="signup-name" type="text" placeholder="Full Name" class="w-full p-3 mb-4 border rounded-lg">
            <input id="signup-room" type="text" placeholder="Room Number (e.g., A-101)" class="w-full p-3 mb-4 border rounded-lg">
            <input id="signup-email" type="email" placeholder="Email" class="w-full p-3 mb-4 border rounded-lg">
            <input id="signup-password" type="password" placeholder="Password" class="w-full p-3 mb-4 border rounded-lg">
            <button id="signup-btn" class="w-full p-3 bg-amber-400 text-white font-bold rounded-lg hover:bg-amber-500">Sign Up</button>
            <p class="text-center text-gray-500 mt-4">Already have an account? <a href="#" id="show-login-page-btn" class="text-amber-500 font-semibold">Log In</a></p>
        </div>

        <!-- College Entry Page (CHANGED BACK TO SELECTION) -->
        <div id="college-select-page" class="page absolute inset-0 z-30 p-8 flex flex-col justify-center bg-gray-50 hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Select your college</h2>
            <p class="text-gray-500 mb-6">Choose your college from the list below.</p>
            <select id="college-name-select" class="w-full p-3 mb-4 border border-gray-300 rounded-lg bg-white">
                <option value="" disabled selected>-- Select a College --</option>
                <option value="SRM AP">SRM AP</option>
                <option value="VIT">VIT</option>
            </select>
            <button id="submit-college-btn" class="w-full p-3 bg-amber-400 text-white font-bold rounded-lg hover:bg-amber-500">Next</button>
        </div>
        
        <!-- Hostel Entry Page (CHANGED BACK TO SELECTION) -->
        <div id="hostel-select-page" class="page absolute inset-0 z-20 p-8 flex flex-col bg-gray-50 hidden">
             <h2 class="text-3xl font-bold text-gray-800 mb-2">Select your hostel</h2>
             <p id="hostel-prompt-college" class="text-gray-500 mb-6">Please choose your hostel.</p>
             <ul id="hostel-list" class="space-y-3">
                <!-- Hostels will be populated here -->
             </ul>
        </div>

        <!-- Main App Interface -->
        <div id="main-app" class="page absolute inset-0 z-10 flex flex-col h-full hidden">
            <!-- Top Header -->
            <header class="p-4 border-b bg-white flex flex-col items-center">
                <div class="flex items-center space-x-2">
                    <img src="app/kravings.png" alt="myKravings Logo" class="h-8 w-8">
                    <h1 class="text-2xl font-bold text-gray-800">myKravings</h1>
                </div>
                <div class="flex items-center space-x-2 mt-2">
                    <span class="text-sm text-gray-500">Showing snacks in</span>
                    <div class="px-3 py-1 bg-amber-100/50 border border-amber-200/80 rounded-full">
                         <p id="hostel-name-header" class="text-sm font-semibold text-amber-800"></p>
                    </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <main id="main-content" class="flex-1 overflow-y-auto p-4 bg-gray-50 no-scrollbar pb-24">
                <!-- Home Tab -->
                <div id="home-tab">
                    <div id="snack-grid" class="grid grid-cols-2 gap-4">
                        <!-- Snack cards will be injected here -->
                    </div>
                </div>
                <!-- Profile Tab -->
                <div id="profile-tab" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">My Profile</h2>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <p id="profile-user-name" class="font-semibold">User: Student123</p>
                        <p id="profile-user-college" class="text-gray-600">College: Bennett University</p>
                        <p id="profile-hostel-name" class="text-gray-600">Hostel: Nelson Mandela</p>
                    </div>
                    <button id="logout-btn" class="w-full mt-6 p-3 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600">Log Out</button>
                    <h3 class="text-xl font-bold text-gray-800 mt-6 mb-3">My Listed Snacks</h3>
                    <div id="my-listed-snacks" class="space-y-3">
                        <!-- User's listed snacks and bids will appear here -->
                    </div>
                </div>
            </main>

            <!-- Bottom Navigation -->
            <nav class="absolute bottom-0 left-0 right-0 h-20 bg-white border-t-2 border-gray-200 flex items-center justify-around px-4">
                <button data-tab="home-tab" class="nav-btn flex flex-col items-center text-amber-500">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                    <span class="text-xs font-semibold">Feed</span>
                </button>
                <button id="open-exchange-modal-btn" class="transform -translate-y-6">
                    <div class="bg-amber-400 text-white w-20 h-14 rounded-2xl flex flex-col items-center justify-center shadow-lg hover:bg-amber-500 transition-all">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                        <span class="text-xs font-bold mt-1">Exchange</span>
                    </div>
                </button>
                <button data-tab="profile-tab" class="nav-btn flex flex-col items-center text-gray-500">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    <span class="text-xs font-semibold">Me</span>
                </button>
            </nav>
        </div>

        <!-- Snack Listing Modal -->
        <div id="exchange-modal" class="modal fixed inset-0 z-50 flex items-end justify-center hidden">
            <div class="modal-bg absolute inset-0 bg-black opacity-50"></div>
            <div class="modal-content bg-white w-full max-w-md rounded-t-2xl p-6 relative">
                <h2 class="text-2xl font-bold text-center mb-4">List Your Snack</h2>
                <label for="snack-photo-upload" class="cursor-pointer">
                    <img id="snack-photo-preview" src="https://placehold.co/400x200/eee/ccc?text=Tap+to+Take+Photo" class="h-32 w-full object-cover bg-gray-200 rounded-lg flex items-center justify-center mb-4 text-gray-500">
                </label>
                <input id="snack-photo-upload" type="file" accept="image/*" capture="environment" class="hidden">
                <input id="snack-name-input" type="text" placeholder="Snack Name" class="w-full p-3 mb-4 border rounded-lg">
                <div class="flex space-x-4 mb-4">
                    <label class="flex-1"><input type="radio" name="listingType" value="Barter" class="mr-2" checked>Barter</label>
                    <label class="flex-1"><input type="radio" name="listingType" value="Price" class="mr-2">Set Price</label>
                </div>
                <input id="snack-price-input" type="number" placeholder="Enter Price (₹)" class="w-full p-3 mb-4 border rounded-lg hidden">
                <button id="list-snack-btn" class="w-full p-3 bg-amber-400 text-white font-bold rounded-lg">List Snack</button>
                <button id="close-exchange-modal-btn" class="absolute top-4 right-4 text-gray-500">&times;</button>
            </div>
        </div>

        <!-- Snack Detail & Bidding Page -->
        <div id="snack-detail-page" class="page absolute inset-0 z-30 bg-white p-6 flex flex-col hidden">
             <button id="close-detail-page-btn" class="absolute top-4 left-4 text-gray-600 z-10">&lt; Back</button>
             <div id="snack-detail-content" class="flex-1 overflow-y-auto no-scrollbar pt-8">
                <!-- Content will be injected here -->
             </div>
        </div>

         <!-- Bid Accepted Modal -->
        <div id="bid-accepted-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
            <div class="modal-bg absolute inset-0 bg-black opacity-50"></div>
            <div class="modal-content bg-white w-full max-w-sm rounded-2xl p-6 relative text-center">
                 <h2 class="text-2xl font-bold text-green-500 mb-2">Bid Accepted!</h2>
                 <p class="text-gray-700 mb-4">You can now exchange your snack.</p>
                 <div id="contact-info" class="bg-gray-100 p-4 rounded-lg">
                     <!-- Contact info will be injected here -->
                 </div>
                 <button id="close-bid-accepted-modal-btn" class="mt-4 w-full p-2 bg-amber-400 text-white font-bold rounded-lg">Awesome!</button>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast-notification" class="absolute bottom-24 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg text-white text-sm font-semibold shadow-lg transition-all duration-300 opacity-0 -translate-y-4 pointer-events-none z-50">
            This is a toast message.
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, onSnapshot, addDoc, updateDoc, query, where, serverTimestamp, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        document.addEventListener('DOMContentLoaded', () => {
            // --- FIREBASE SETUP ---
            const firebaseConfig = {
              apiKey: "AIzaSyA2dmDva2fu3RDtj7wr2CFh8UPDS4pfdDo",
              authDomain: "karvings-4c80d.firebaseapp.com",
              projectId: "karvings-4c80d",
              storageBucket: "karvings-4c80d.appspot.com",
              messagingSenderId: "164212138890",
              appId: "1:164212138890:web:a6c85d9b0fe4ab506ede73",
              measurementId: "G-3YN72HBJSB"
            };
            const appId = 'karvings-4c80d';
            
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const storage = getStorage(app);

            let currentUser = null;
            let userProfile = null;
            let tempCollegeName = null; // To hold college name between steps

            const collegeHostels = {
                "SRM AP": ["GANGA", "VEDAVATHI"],
                "VIT": ["BH-1 (Boys)", "BH-2 (Boys)", "GH-1 (Girls)"]
            };

            // --- UI HELPERS ---
            let toastTimeout;
            const showToast = (message, isError = false) => {
                const toast = document.getElementById('toast-notification');
                if (!toast) return;
                clearTimeout(toastTimeout);
                toast.textContent = message;
                toast.className = 'absolute bottom-24 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg text-white text-sm font-semibold shadow-lg transition-all duration-300 pointer-events-none z-50'; // Reset classes
                toast.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
                toast.classList.remove('opacity-0', '-translate-y-4');
                toast.classList.add('opacity-100', 'translate-y-0');
                toastTimeout = setTimeout(() => {
                    toast.classList.remove('opacity-100', 'translate-y-0');
                    toast.classList.add('opacity-0', '-translate-y-4');
                }, 3000);
            };

            // --- PAGE NAVIGATION ---
            const pages = document.querySelectorAll('.page');
            const navigateTo = (pageId) => {
                pages.forEach(page => page.classList.add('hidden'));
                document.getElementById(pageId).classList.remove('hidden');
            };

            // --- AUTHENTICATION ---
            setTimeout(() => { // Show splash for a bit
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, user.uid);
                        const userDoc = await getDoc(userDocRef);

                        if (userDoc.exists()) {
                            userProfile = userDoc.data();
                            if (userProfile.college && userProfile.hostel) {
                                setupMainApp(userProfile.college, userProfile.hostel); // Go straight to main app
                            } else {
                                navigateTo('college-select-page');
                            }
                        } else {
                           // This case might happen if user is created but doc fails.
                           navigateTo('college-select-page');
                        }
                    } else {
                        currentUser = null;
                        userProfile = null;
                        navigateTo('login-page');
                    }
                });
            }, 1500);

            document.getElementById('show-signup-page-btn').addEventListener('click', (e) => { e.preventDefault(); navigateTo('signup-page'); });
            document.getElementById('show-login-page-btn').addEventListener('click', (e) => { e.preventDefault(); navigateTo('login-page'); });
            
            // SIGN UP
            document.getElementById('signup-btn').addEventListener('click', async () => {
                const name = document.getElementById('signup-name').value;
                const room = document.getElementById('signup-room').value;
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                if (!name || !room || !email || !password) { showToast("Please fill all fields.", true); return; }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, user.uid);
                    await setDoc(userDocRef, {
                        name: name,
                        room: room,
                        email: email,
                        college: null,
                        hostel: null
                    });
                } catch (error) {
                    showToast(`Signup failed: ${error.message}`, true);
                }
            });

            // LOGIN
            document.getElementById('login-btn').addEventListener('click', async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if (!email || !password) { showToast("Please enter email and password.", true); return; }
                
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    showToast(`Login failed: ${error.message}`, true);
                }
            });

            // LOGOUT
            document.getElementById('logout-btn').addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    navigateTo('login-page');
                } catch (error) {
                    showToast(`Logout failed: ${error.message}`, true);
                }
            });
            
            // --- SELECTION-BASED ONBOARDING FLOW ---
            document.getElementById('submit-college-btn').addEventListener('click', () => {
                const selectedCollege = document.getElementById('college-name-select').value;
                if (!selectedCollege) {
                    showToast("Please select a college.", true);
                    return;
                }
                tempCollegeName = selectedCollege;
                populateHostels(selectedCollege);
                navigateTo('hostel-select-page');
            });

            const populateHostels = (collegeName) => {
                const hostelList = document.getElementById('hostel-list');
                const prompt = document.getElementById('hostel-prompt-college');
                hostelList.innerHTML = ''; // Clear previous list
                prompt.textContent = `Select your hostel at ${collegeName}.`;

                const hostels = collegeHostels[collegeName] || [];
                
                hostels.forEach(hostelName => {
                    const li = document.createElement('li');
                    li.className = 'p-3 bg-white border rounded-lg cursor-pointer hover:bg-amber-100 transition-colors';
                    li.textContent = hostelName;
                    li.addEventListener('click', async () => {
                        // Save selection to user profile
                        const userDocRef = doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid);
                        await setDoc(userDocRef, {
                            college: collegeName,
                            hostel: hostelName
                        }, { merge: true });

                        // Update local profile and go to app
                        userProfile.college = collegeName;
                        userProfile.hostel = hostelName;
                        setupMainApp(collegeName, hostelName);
                    });
                    hostelList.appendChild(li);
                });
            };

            // --- SETUP MAIN APP INTERFACE ---
            const setupMainApp = (collegeName, hostelName) => {
                document.getElementById('hostel-name-header').textContent = hostelName;
                document.getElementById('profile-user-name').textContent = `User: ${userProfile.name}`;
                document.getElementById('profile-user-college').textContent = `College: ${collegeName}`;
                document.getElementById('profile-hostel-name').textContent = `Hostel: ${hostelName}`;
                listenForSnacks(hostelName);
                navigateTo('main-app');
            };

            // --- MAIN APP (REAL-TIME) ---
            let unsubscribeSnacks = null;
            const listenForSnacks = (hostelName) => {
                if (unsubscribeSnacks) unsubscribeSnacks();
                
                const snackGrid = document.getElementById('snack-grid');
                const snacksRef = collection(db, `/artifacts/${appId}/public/data/snacks`);
                const q = query(snacksRef, where("hostel", "==", hostelName));
                
                unsubscribeSnacks = onSnapshot(q, (querySnapshot) => {
                    snackGrid.innerHTML = '';
                    if (querySnapshot.empty) {
                        snackGrid.innerHTML = '<p class="col-span-2 text-center text-gray-500">No snacks offered. Be the first!</p>';
                    }
                    querySnapshot.forEach((doc) => {
                        const snack = doc.data();
                        const snackId = doc.id;
                        if(snack.status === 'exchanged') return; // Don't show exchanged snacks
                        const card = document.createElement('div');
                        card.className = 'bg-white rounded-lg shadow-md overflow-hidden';
                        card.innerHTML = `
                            <img src="${snack.image}" alt="${snack.name}" class="w-full h-32 object-cover">
                            <div class="p-3">
                                <h3 class="font-bold truncate">${snack.name}</h3>
                                <p class="text-sm ${snack.type === 'Barter' ? 'text-blue-500' : 'text-green-500'} font-semibold">
                                    ${snack.type === 'Barter' ? 'For Exchange' : `₹${snack.price}`}
                                </p>
                            </div>
                        `;
                        card.addEventListener('click', () => showSnackDetail(snackId));
                        snackGrid.appendChild(card);
                    });
                });
            };

            // Bottom Nav
            const navButtons = document.querySelectorAll('.nav-btn');
            const mainContentTabs = [document.getElementById('home-tab'), document.getElementById('profile-tab')];
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    navButtons.forEach(b => b.classList.replace('text-amber-500', 'text-gray-500'));
                    btn.classList.replace('text-gray-500', 'text-amber-500');
                    const tabId = btn.dataset.tab;
                    mainContentTabs.forEach(tab => tab.classList.add('hidden'));
                    document.getElementById(tabId).classList.remove('hidden');
                    if (tabId === 'profile-tab') listenForMyListedSnacks();
                });
            });

            // --- SNACK LISTING MODAL ---
            const exchangeModal = document.getElementById('exchange-modal');
            const listSnackBtn = document.getElementById('list-snack-btn');
            document.getElementById('open-exchange-modal-btn').addEventListener('click', () => exchangeModal.classList.remove('hidden'));
            document.getElementById('close-exchange-modal-btn').addEventListener('click', () => exchangeModal.classList.add('hidden'));
            exchangeModal.querySelector('.modal-bg').addEventListener('click', () => exchangeModal.classList.add('hidden'));
            
            document.querySelectorAll('input[name="listingType"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('snack-price-input').classList.toggle('hidden', e.target.value !== 'Price');
                });
            });
            
            // Image Preview for Listing
            document.getElementById('snack-photo-upload').addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('snack-photo-preview').src = event.target.result;
                    }
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            listSnackBtn.addEventListener('click', async () => {
                if (!currentUser || !userProfile) { return; }
                const name = document.getElementById('snack-name-input').value;
                const type = document.querySelector('input[name="listingType"]:checked').value;
                const price = document.getElementById('snack-price-input').value;
                const photoFile = document.getElementById('snack-photo-upload').files[0];
                let priceValue = null;

                // Improved validation to prevent bad data
                if (type === 'Price') {
                    if (!price) {
                        showToast("Please enter a price for the snack.", true);
                        return;
                    }
                    priceValue = parseInt(price);
                    if (isNaN(priceValue) || priceValue < 0) {
                        showToast("Please enter a valid, positive number for the price.", true);
                        return;
                    }
                }

                if (!name || !photoFile) {
                    showToast("Please add a snack name and a photo.", true);
                    return;
                }

                listSnackBtn.disabled = true;
                listSnackBtn.textContent = 'Listing...';

                try {
                    // 1. Upload image to Storage
                    const filePath = `snacks/${currentUser.uid}/${Date.now()}-${photoFile.name}`;
                    const storageRef = ref(storage, filePath);
                    const snapshot = await uploadBytes(storageRef, photoFile);
                    const downloadURL = await getDownloadURL(snapshot.ref);

                    // 2. Add snack info to Firestore
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/snacks`), {
                        ownerId: currentUser.uid,
                        ownerName: userProfile.name,
                        room: userProfile.room,
                        name, type,
                        price: priceValue, // Use validated and parsed price
                        image: downloadURL,
                        college: userProfile.college,
                        hostel: userProfile.hostel,
                        createdAt: serverTimestamp(),
                        status: 'available' // available, exchanged
                    });

                    // Reset modal
                    exchangeModal.classList.add('hidden');
                    document.getElementById('snack-name-input').value = '';
                    document.getElementById('snack-price-input').value = '';
                    document.getElementById('snack-photo-upload').value = '';
                    document.getElementById('snack-photo-preview').src = 'https://placehold.co/400x200/eee/ccc?text=Tap+to+Take+Photo';
                    showToast("Snack listed successfully!");
                } catch (error) {
                    console.error("Error listing snack: ", error);
                    showToast("Failed to list snack.", true);
                } finally {
                    listSnackBtn.disabled = false;
                    listSnackBtn.textContent = 'List Snack';
                }
            });

            // --- SNACK DETAIL & BIDDING ---
            let currentSnackListener = null;
            const showSnackDetail = (snackId) => {
                if (currentSnackListener) currentSnackListener(); // Detach previous listener

                 const snackDocRef = doc(db, `/artifacts/${appId}/public/data/snacks`, snackId);
                 currentSnackListener = onSnapshot(snackDocRef, (doc) => {
                    if(!doc.exists()) {
                        navigateTo('main-app');
                        return;
                    }
                    const snack = doc.data();
                    const contentDiv = document.getElementById('snack-detail-content');
                    contentDiv.innerHTML = `
                        <img src="${snack.image}" class="w-full h-64 object-cover rounded-lg mb-4">
                        <h2 class="text-3xl font-bold">${snack.name}</h2>
                        <p class="text-lg text-gray-500 mb-2">Listed by ${snack.ownerName} (${snack.room})</p>
                        <p class="text-xl font-semibold ${snack.type === 'Barter' ? 'text-blue-600' : 'text-green-600'} mb-6">
                            ${snack.type === 'Barter' ? 'Available for Barter' : `Price: ₹${snack.price}`}
                        </p>
                        ${snack.ownerId !== currentUser.uid ? `
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <h3 class="font-bold mb-3">Bid Your Snack</h3>
                            <label for="bid-photo-upload" class="cursor-pointer">
                                <img id="bid-photo-preview" src="https://placehold.co/400x150/eee/ccc?text=Take+Photo+of+Your+Snack" class="h-24 w-full object-cover bg-gray-200 rounded flex items-center justify-center mb-3 text-gray-500 text-sm">
                            </label>
                            <input id="bid-photo-upload" type="file" accept="image/*" capture="environment" class="hidden">
                            <input id="bid-snack-name" type="text" placeholder="Your snack's name" class="w-full p-2 border rounded mb-3">
                            <button id="submit-bid-btn" data-snack-id="${snackId}" class="w-full p-3 bg-amber-400 text-white font-bold rounded-lg">Submit Bid</button>
                        </div>` : '<p class="text-center text-gray-500">This is your listing.</p>'}
                    `;
                 });
                 navigateTo('snack-detail-page');
            };
            
            // Event delegation for dynamically created elements
            document.getElementById('snack-detail-content').addEventListener('change', e => {
                if (e.target.id === 'bid-photo-upload' && e.target.files && e.target.files[0]) {
                     const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('bid-photo-preview').src = event.target.result;
                    }
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            document.getElementById('snack-detail-content').addEventListener('click', async e => {
                 if (e.target.id === 'submit-bid-btn') {
                    e.target.disabled = true;
                    e.target.textContent = 'Submitting...';
                    const snackId = e.target.dataset.snackId;
                    const bidSnackName = document.getElementById('bid-snack-name').value;
                    const bidPhotoFile = document.getElementById('bid-photo-upload').files[0];
                    if (!bidSnackName || !bidPhotoFile) {
                        showToast('Please enter snack name and add a photo.', true);
                        e.target.disabled = false;
                        e.target.textContent = 'Submit Bid';
                        return;
                    }

                    try {
                        // 1. Upload bid image
                        const filePath = `bids/${currentUser.uid}/${Date.now()}-${bidPhotoFile.name}`;
                        const storageRef = ref(storage, filePath);
                        const snapshot = await uploadBytes(storageRef, bidPhotoFile);
                        const downloadURL = await getDownloadURL(snapshot.ref);

                        // 2. Add bid to subcollection
                        const bidsCollectionRef = collection(db, `/artifacts/${appId}/public/data/snacks`, snackId, 'bids');
                        await addDoc(bidsCollectionRef, {
                            bidderId: currentUser.uid,
                            bidderName: userProfile.name,
                            bidderRoom: userProfile.room,
                            snackName: bidSnackName,
                            snackImage: downloadURL,
                            createdAt: serverTimestamp()
                        });

                        showToast('Bid submitted successfully!');
                        navigateTo('main-app');
                    } catch (error) {
                        console.error("Error submitting bid:", error);
                        showToast('Failed to submit bid.', true);
                        e.target.disabled = false;
                        e.target.textContent = 'Submit Bid';
                    }
                 }
            });

            document.getElementById('close-detail-page-btn').addEventListener('click', () => {
                if (currentSnackListener) currentSnackListener();
                navigateTo('main-app');
            });

            // --- PROFILE & BID MANAGEMENT ---
            let mySnacksListeners = [];
            const listenForMyListedSnacks = () => {
                mySnacksListeners.forEach(unsub => unsub()); // Unsubscribe from all previous listeners
                mySnacksListeners = [];

                const container = document.getElementById('my-listed-snacks');
                const q = query(collection(db, `/artifacts/${appId}/public/data/snacks`), where("ownerId", "==", currentUser.uid));

                const snacksUnsub = onSnapshot(q, (snapshot) => {
                    container.innerHTML = '';
                    if (snapshot.empty) {
                        container.innerHTML = '<p class="text-gray-500 text-center">You haven\'t listed any snacks yet.</p>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const snack = doc.data();
                        const snackId = doc.id;
                        const listingDiv = document.createElement('div');
                        listingDiv.className = 'bg-white p-3 rounded-lg shadow';
                        
                        let statusInfo = '';
                        if (snack.status === 'exchanged') {
                             statusInfo = `<p class="text-sm text-green-600 font-semibold mt-2">Exchanged with ${snack.exchangedWith.bidderName}!</p>`;
                        }

                        listingDiv.innerHTML = `<p class="font-bold">${snack.name}</p>${statusInfo}<div class="bids-container mt-2" id="bids-for-${snackId}"><p class="text-sm text-gray-500">Loading bids...</p></div>`;
                        container.appendChild(listingDiv);

                        if (snack.status !== 'exchanged') {
                            const bidsContainer = document.getElementById(`bids-for-${snackId}`);
                            const bidsQuery = query(collection(db, `/artifacts/${appId}/public/data/snacks`, snackId, 'bids'));
                            const bidsUnsub = onSnapshot(bidsQuery, (bidsSnapshot) => {
                                if (bidsSnapshot.empty) {
                                    bidsContainer.innerHTML = '<p class="text-sm text-gray-500">No bids yet.</p>';
                                    return;
                                }
                                bidsContainer.innerHTML = bidsSnapshot.docs.map(bidDoc => {
                                    const bid = bidDoc.data();
                                    const bidId = bidDoc.id;
                                    return `
                                    <div class="flex items-center justify-between mt-2 p-2 bg-gray-50 rounded">
                                        <div class="flex items-center min-w-0">
                                            <img src="${bid.snackImage}" class="w-10 h-10 rounded mr-2 object-cover flex-shrink-0">
                                            <div class="min-w-0">
                                                <p class="font-semibold text-sm truncate">${bid.snackName}</p>
                                                <p class="text-xs text-gray-500 truncate">from ${bid.bidderName}</p>
                                            </div>
                                        </div>
                                        <button class="accept-bid-btn text-xs bg-green-500 text-white px-2 py-1 rounded flex-shrink-0" data-snack-id="${snackId}" data-bid-id="${bidId}">Accept</button>
                                    </div>
                                    `;
                                }).join('');
                            });
                            mySnacksListeners.push(bidsUnsub);
                        }
                    });
                });
                mySnacksListeners.push(snacksUnsub);
            };
            
            document.getElementById('my-listed-snacks').addEventListener('click', async e => {
                if (e.target.classList.contains('accept-bid-btn')) {
                    const snackId = e.target.dataset.snackId;
                    const bidId = e.target.dataset.bidId;
                    
                    const snackDocRef = doc(db, `/artifacts/${appId}/public/data/snacks`, snackId);
                    const bidDocRef = doc(db, `/artifacts/${appId}/public/data/snacks`, snackId, 'bids', bidId);
                    
                    const snackDoc = await getDoc(snackDocRef);
                    const bidDoc = await getDoc(bidDocRef);

                    if(snackDoc.exists() && bidDoc.exists()){
                        const snack = snackDoc.data();
                        const winningBid = bidDoc.data();
                        
                        await updateDoc(snackDocRef, {
                            status: 'exchanged',
                            exchangedWith: winningBid
                        });
                        
                        showBidAcceptedModal(snack, winningBid);
                    }
                }
            });

            const bidAcceptedModal = document.getElementById('bid-accepted-modal');
            const showBidAcceptedModal = (listedSnack, winningBid) => {
                document.getElementById('contact-info').innerHTML = `
                    <p><strong>Lister:</strong> ${listedSnack.ownerName}</p>
                    <p><strong>Room:</strong> ${listedSnack.room}</p>
                    <hr class="my-2">
                    <p><strong>Bidder:</strong> ${winningBid.bidderName}</p>
                    <p><strong>Room:</strong> ${winningBid.bidderRoom}</p>
                `;
                bidAcceptedModal.classList.remove('hidden');
            };
            document.getElementById('close-bid-accepted-modal-btn').addEventListener('click', () => {
                bidAcceptedModal.classList.add('hidden');
            });
        });
    </script>
</body>
</html>

