<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Gappkar Online</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <style>
    /* --- Chat Container Styles --- */
    #chat-container {
        width: 100%;
        max-width: 400px;
        height: 90vh;
        max-height: 700px;
        background-color: #ffffff;
        border: 1px solid #dbdbdb;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    #message-list {
        flex-grow: 1;
        padding: 16px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .system-message {
        text-align: center;
        font-size: 12px;
        color: #8e8e8e;
        padding: 8px;
        background-color: #f0f2f5;
        border-radius: 12px;
    }
    .chat-message {
        display: flex;
        max-width: 75%;
    }
    .chat-message.sent {
        align-self: flex-end;
    }
    .chat-message img {
        max-width: 100%;
        border-radius: 16px;
    }
    #chat-input-bar {
        padding: 10px;
        border-top: 1px solid #dbdbdb;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    #chat-input-bar input {
        flex-grow: 1;
        border: 1.5px solid #dbdbdb;
        border-radius: 18px;
        padding: 80px 12px;
        font-size: 14px;
        background-color: #f5f5f5;
    }
    #gif-tab-button {
        background-color: #ffffff;
        color: #262626;
        border: 1.5px solid #dbdbdb;
        padding: 0;
        width: 50px;
        height: 36px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: background-color 0.2s, border-color 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        flex-shrink: 0;
    }
    #gif-tab-button:hover {
        background-color: #f5f5f5;
        border-color: #c7c7c7;
    }

    /* --- Enhanced Chat Input Area --- */
    .chat-input-area {
        flex-shrink: 0;
        border-top: var(--border-thin);
        background-color: var(--bg-light);
    }
    .input-row {
        padding: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .expand-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 20px;
        color: var(--text-dark);
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease, background-color 0.2s;
    }
    .expand-btn:hover {
        background-color: var(--system-bg);
    }
    .expand-btn.active {
        transform: rotate(45deg);
        background-color: var(--accent);
        color: var(--text-light);
    }
    .chat-audio-play-btn {
        width: 28px; height: 28px; border-radius: 50%; border: none;
        background: var(--accent); color: white; cursor: pointer;
        font-size: 12px; flex-shrink: 0;
    }

    /* --- Expandable Options Panel --- */
    .expand-options {
        display: flex;
        justify-content: space-around;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
        padding: 0 8px;
        border-bottom: 1px solid transparent;
    }
    .expand-options.visible {
        max-height: 100px;
        padding: 12px 8px;
        border-bottom: 1px solid var(--border-thin);
    }
    .expand-option-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        background: none;
        border: none;
        cursor: pointer;
        font-family: inherit;
        font-size: 12px;
        color: var(--gray);
    }
    .expand-option-btn .icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: var(--border-thin);
        background-color: var(--bg-light);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: var(--text-dark);
    }
    .expand-option-btn:hover .icon {
        background-color: var(--system-bg);
    }

    /* --- Feature Panels (Stickers, Audio) --- */
    .feature-panel {
        background-color: var(--bg-light);
        padding: 0;
        display: flex;
        flex-direction: column;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
    }
    .feature-panel.visible {
        max-height: 280px;
    }
    .feature-panel-header {
        display: flex;
        align-items: center;
        padding: 8px 16px;
        border-bottom: var(--border-thin);
        flex-shrink: 0;
    }
    .feature-panel-title {
        flex-grow: 1;
        font-weight: 600;
        color: var(--text-dark);
        font-size: 14px;
    }
    .feature-panel-close-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: var(--border-thin);
        background: transparent;
        color: var(--text-dark);
        cursor: pointer;
        font-size: 16px;
    }
    .feature-panel-content {
        padding: 16px;
        overflow-y: auto;
        flex-grow: 1;
    }
    .feature-search-bar {
        width: 100%;
        padding: 10px 16px;
        border-radius: 20px;
        border: var(--border-thin);
        background-color: var(--bg-light);
        font-size: 14px;
        font-family: inherit;
        margin-bottom: 16px;
        outline: none;
        color: var(--text-dark);
    }
    #stickerGrid, #gif-results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
    }
    .sticker-item, .gif-item {
        width: 100%;
        aspect-ratio: 1 / 1;
        background-color: var(--system-bg);
        border-radius: var(--border-radius);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
        overflow: hidden;
    }
    .sticker-item:hover, .gif-item:hover {
        transform: scale(1.1);
    }
    .sticker-item img, .gif-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    #audioList {
        list-style: none;
    }
    .audio-item {
        display: flex;
        align-items: center;
        padding: 8px;
        border-radius: var(--border-radius);
        cursor: pointer;
        margin-bottom: 8px;
        border: var(--border-thin);
    }
    .audio-item:hover {
        background-color: var(--system-bg);
    }
    .audio-item .play-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background-color: var(--accent);
        color: white;
        font-size: 14px;
        margin-right: 12px;
        cursor: pointer;
        flex-shrink: 0;
    }
    .audio-item .audio-name {
        font-size: 14px;
        color: var(--text-dark);
    }
    .loader {
        margin: 40px auto;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #0095f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    :root {
      --bg-dark: #000000;
      --bg-light: #ffffff;
      --text-dark: #000000;
      --text-light: #ffffff;
      --accent: #ff3b30;
      --gray: #888888;
      --border-radius: 12px;
      --border-thin: 1.5px solid #000;
      --system-bg: #f5f5f5;
      --system-text: #666666;
      --modal-bg: rgba(0, 0, 0, 0.8);
      --pastel-accent: #f0f2f5;
      --shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
    }
    
    [data-theme="dark"] {
      --bg-dark: #ffffff;
      --bg-light: #000000;
      --text-dark: #ffffff;
      --text-light: #000000;
      --accent: #ff3b30;
      --gray: #aaaaaa;
      --border-thin: 1.5px solid #fff;
      --system-bg: #1a1a1a;
      --system-text: #cccccc;
      --modal-bg: rgba(255, 255, 255, 0.8);
      --pastel-accent: #1a1a1a;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: background-color 0.3s ease,
                  border-color 0.3s ease,
                  color 0.3s ease;
    }
    
    body {
      font-family: 'DotGothic16', monospace;
      background: var(--bg-light);
      color: var(--text-dark);
      letter-spacing: 0.5px;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      position: relative;
    }
    
    .app-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px;
    }
    
    .main-container {
      width: 100%;
      max-width: 400px;
      background: var(--bg-light);
      border-radius: var(--border-radius);
      border: var(--border-thin);
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    
    .app-header {
      background: var(--bg-light);
      padding: 20px;
      text-align: center;
      border-bottom: var(--border-thin);
    }
    
    .chat-active .app-header {
      display: none !important;
    }
    
    .theme-toggle {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: var(--border-thin);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dark);
    }
    .theme-toggle:hover {
      background: var(--accent);
      color: var(--text-light);
    }
    
    .logo-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    
    .logo-icon {
      width: 64px;
      height: 64px;
      border-radius: var(--border-radius);
      display: flex;
      align-items: center;
      justify-content: center;
      border: var(--border-thin);
      font-weight: 700;
      font-size: 24px;
      background: var(--bg-light);
      color: var(--text-dark);
      overflow: hidden;
    }
    
    .logo-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: var(--border-radius);
    }
    
    .app-title {
      font-size: 26px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-dark);
    }
    .app-subtitle {
      font-size: 13px;
      color: var(--gray);
    }
    
    #joinView {
      padding: 24px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .view.hidden {
      display: none !important;
    }
    
    .section-header {
      text-align: center;
      margin-bottom: 24px;
    }
    .section-icon {
      font-size: 28px;
      margin-bottom: 12px;
    }
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      color: var(--text-dark);
    }
    .section-description {
      color: var(--gray);
      font-size: 14px;
    }
    .form-group {
      margin-bottom: 18px;
    }
    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      font-size: 14px;
      color: var(--text-dark);
    }
    .form-input {
      width: 100%;
      padding: 12px;
      border: var(--border-thin);
      border-radius: var(--border-radius);
      font-size: 14px;
      font-family: inherit;
      background: var(--bg-light);
      color: var(--text-dark);
      outline: none;
    }
    .form-input:focus {
      border-color: var(--accent);
    }
    .form-input::placeholder {
      color: var(--gray);
    }
    .location-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #locationStatus {
      padding: 8px;
      border-radius: var(--border-radius);
      text-align: center;
      margin-top: 10px;
      font-size: 12px;
      border: var(--border-thin);
    }
    #locationStatus.success {
      background: #d4edda;
      color: #155724;
      border-color: #c3e6cb;
    }
    #locationStatus.error {
      background: #f8d7da;
      color: #721c24;
      border-color: #f5c6cb;
    }
    .btn {
      width: 100%;
      padding: 14px;
      border-radius: var(--border-radius);
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      cursor: pointer;
      border: none;
      font-family: inherit;
    }
    .btn-location {
      background: var(--bg-dark);
      color: var(--text-light);
      margin-bottom: 0;
    }
    .btn-location:hover {
      background: var(--accent);
    }
    .btn-success {
      background: var(--bg-dark);
      color: var(--text-light);
    }
    .btn-success:hover {
      background: var(--accent);
    }
    
    #chatsView {
      display: none;
      flex-direction: column;
      background: var(--bg-light);
      height: 100%;
      max-height: 100vh;
      overflow: hidden;
    }
    #chatsView:not(.hidden) {
      display: flex !important;
    }
    
    .chat-header {
      background: var(--bg-light);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: var(--border-thin);
      flex-shrink: 0;
    }
    
    .back-button, .header-btn {
      border: var(--border-thin);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      font-size: 16px;
      color: var(--text-dark);
    }
    .back-button:hover, .header-btn:hover {
      background: var(--accent);
      color: var(--text-light);
    }
    
    .chat-header-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-logo-section {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }
    .header-logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: var(--border-thin);
      font-weight: 600;
      font-size: 14px;
      background: var(--bg-light);
      color: var(--text-dark);
      flex-shrink: 0;
      overflow: hidden;
    }
    .header-logo-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }
    .header-app-info {
      flex: 1;
      min-width: 0;
    }
    .header-app-name {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--text-dark);
      letter-spacing: 1px;
      line-height: 1.2;
    }
    .header-room-info {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--gray);
      margin-top: 2px;
    }
    .room-indicator {
      background: var(--accent);
      color: var(--text-light);
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .online-dot {
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .create-room-btn {
      border: var(--border-thin);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      font-size: 16px;
      color: var(--text-dark);
    }
    .create-room-btn:hover {
      background: var(--accent);
      color: var(--text-light);
    }
    .room-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: var(--modal-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .room-modal.show {
      opacity: 1;
      visibility: visible;
    }
    .room-modal-content {
      background: var(--bg-light);
      border: var(--border-thin);
      border-radius: var(--border-radius);
      padding: 24px;
      max-width: 350px;
      width: 90%;
      position: relative;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }
    .room-modal.show .room-modal-content {
      transform: scale(1);
    }
    .room-modal-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .room-modal-title {
      font-size: 18px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-dark);
      margin-bottom: 8px;
    }
    .room-modal-description {
      font-size: 14px;
      color: var(--gray);
    }
    .room-modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: transparent;
      border: var(--border-thin);
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--text-dark);
    }
    .room-modal-close:hover {
      background: var(--accent);
      color: var(--text-light);
    }
    .room-buttons {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    .btn-room {
      flex: 1;
      padding: 12px;
      border-radius: var(--border-radius);
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      cursor: pointer;
      border: var(--border-thin);
      font-family: inherit;
      background: transparent;
      color: var(--text-dark);
    }
    .btn-room:hover {
      background: var(--accent);
      color: var(--text-light);
    }
    .btn-room.primary {
      background: var(--bg-dark);
      color: var(--text-light);
    }
    .btn-room.primary:hover {
      background: var(--accent);
    }
    
    #messageList {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--bg-light);
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    .message {
      display: flex;
      width: 100%;
      animation: messageSlideIn 0.3s ease;
    }
    @keyframes messageSlideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message-bubble {
      border: var(--border-thin);
      border-radius: var(--border-radius);
      padding: 10px 14px;
      font-size: 14px;
      word-wrap: break-word;
      max-width: 75%;
      position: relative;
    }
    .message.sent {
      justify-content: flex-end;
    }
    .message.sent .message-bubble {
      background: var(--bg-dark);
      color: var(--text-light);
      border: none;
    }
    .message.received {
      justify-content: flex-start;
    }
    .message.received .message-bubble {
      background: var(--bg-light);
      color: var(--text-dark);
    }
    .message.system {
      justify-content: center;
    }
    .message.system .message-bubble {
      background: var(--system-bg);
      color: var(--system-text);
      border: 1px dashed var(--gray);
      font-size: 12px;
      max-width: 90%;
      text-align: center;
    }
    .message-time {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 4px;
    }
    .sender-name {
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 2px;
      color: var(--accent);
    }
    .message-location {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 2px;
    }
    .message-info {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      max-width: 75%;
    }
    
    /* --- Find/Search View Styles --- */
    .find-view {
        display: flex;
        flex-direction: column;
        padding: 24px;
        flex-grow: 1;
        background-color: var(--bg-light);
    }
    #findMenuView {
        align-items: center;
        justify-content: center;
        text-align: center;
    }
    #findMenuView h2 {
        font-size: 22px;
        margin-bottom: 10px;
        color: var(--text-dark);
    }
    #findMenuView p {
        color: var(--gray);
        margin-bottom: 40px;
    }
    .find-menu-btn {
        width: 100%;
        padding: 16px;
        border-radius: var(--border-radius);
        border: var(--border-thin);
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        margin-bottom: 16px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-family: inherit;
        background: var(--bg-light);
        color: var(--text-dark);
    }
    .find-menu-btn:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
        border-color: var(--accent);
    }
    .find-menu-btn.primary {
        background: var(--bg-dark);
        color: var(--text-light);
        border: none;
    }
    .screen-header {
        text-align: center;
        margin-bottom: 20px;
    }
    .screen-header h2 {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
    }
    .search-bar {
        width: 100%;
        padding: 12px 16px;
        font-size: 14px;
        border-radius: 25px;
        border: var(--border-thin);
        background: var(--pastel-accent);
        margin-bottom: 24px;
        outline: none;
        font-family: inherit;
        color: var(--text-dark);
    }
    .search-bar:focus {
        border-color: var(--accent);
    }
    .user-list {
        list-style: none;
        overflow-y: auto;
        flex-grow: 1;
    }
    .user-card {
        display: flex;
        align-items: center;
        background: var(--bg-light);
        padding: 12px;
        border-radius: var(--border-radius);
        margin-bottom: 12px;
        border: var(--border-thin);
    }
    .profile-pic {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 12px;
        border: var(--border-thin);
    }
    .user-info h3 {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-dark);
    }
    .user-info p {
        font-size: 12px;
        color: var(--gray);
    }
    
    /* --- Mobile & Keyboard Handling --- */
    @media (max-width: 480px) {
      html {
        height: 100%;
        height: -webkit-fill-available;
      }
      body {
        height: 100%;
        height: -webkit-fill-available;
        overflow: hidden;
        position: fixed;
        width: 100%;
      }
      .app-container {
        height: 100%;
        height: -webkit-fill-available;
        padding: 0;
        align-items: stretch;
      }
      .main-container {
        width: 100%;
        height: 100%;
        height: -webkit-fill-available;
        border-radius: 0;
        border: none;
        max-width: none;
      }
      #chatsView:not(.hidden) {
        display: flex !important;
        flex-direction: column;
        height: 100%;
        height: -webkit-fill-available;
        position: relative;
      }
      .chat-header {
        flex-shrink: 0;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      #messageList {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
        padding-bottom: 20px;
      }
      .chat-input-area {
        flex-shrink: 0;
        position: sticky;
        bottom: 0;
        z-index: 100;
        transition: transform 0.3s ease;
      }
      /* Keyboard focused state */
      body.keyboard-visible .chat-input-area {
        transform: translateY(0);
      }
      body.keyboard-visible #messageList {
        padding-bottom: 80px;
      }
    }
    /* iOS Safari specific fixes */
    @supports (-webkit-touch-callout: none) {
      @media (max-width: 480px) {
        body {
          height: -webkit-fill-available;
        }
        .app-container,
        .main-container,
        #chatsView:not(.hidden) {
          height: -webkit-fill-available;
        }
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="main-container" id="mainContainer">
      <div class="app-header">
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
          <span id="themeIcon">🌙</span>
        </button>
        <div class="logo-section">
          <div class="logo-icon">
            <img src="your-icon.jpg" alt="Gappkar Logo" class="logo-image" onerror="this.style.display='none'; this.parentNode.innerHTML='G';">
          </div>
          <h1 class="app-title">gappkar</h1>
          <p class="app-subtitle">Connect with people around you</p>
        </div>
      </div>
      
      <div id="joinView" class="view active">
        <div class="section-header">
          <div class="section-icon">👋</div>
          <h2 class="section-title">Join the Chat</h2>
          <p class="section-description">Enter your info to start gapping</p>
        </div>
        <div class="form-group">
          <label class="form-label" for="usernameInput">Name</label>
          <input type="text" id="usernameInput" class="form-input" placeholder="Enter your display name" maxlength="30" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="ageInput">Age</label>
          <input type="number" id="ageInput" class="form-input" placeholder="Enter your age" min="13" max="99" required>
        </div>
        <div class="form-group">
          <label class="form-label">Location</label>
          <div class="location-options">
            <button type="button" class="btn btn-location" id="getLocationBtn">📍 Get My Location</button>
            <input type="text" id="locationInput" class="form-input" placeholder="Or enter your city manually" style="margin-top: 10px;">
          </div>
        </div>
        <button type="button" class="btn btn-success" id="joinButton">🚀 Start Chatting</button>
        <div id="locationStatus"></div>
      </div>
      
      <div id="chatsView" class="view hidden">
        <div class="chat-header">
          <button class="back-button" id="backButton">←</button>
          <div class="chat-header-info">
            <div class="header-logo-section">
              <div class="header-logo-icon">
                <img src="your-icon.jpg" alt="Gappkar Logo" class="header-logo-image" onerror="this.style.display='none'; this.parentNode.innerHTML='G';">
              </div>
              <div class="header-app-info">
                <div class="header-app-name">gappkar</div>
                <div class="header-room-info">
                  <span class="room-indicator" id="roomIndicator">Global</span>
                  <span class="online-dot"></span>
                  <span id="peopleCount">connecting...</span>
                </div>
              </div>
            </div>
          </div>
          <button class="header-btn" id="findBtn" title="Find Users">🔍</button>
          <button class="create-room-btn" id="createRoomBtn" title="Create/Join Room">+</button>
        </div>
        <div id="messageList"></div>
        
        <!-- ✅ FIXED: Enhanced Chat Input Area -->
        <div class="chat-input-area">
            <!-- Sticker Panel -->
            <div id="stickerPanel" class="feature-panel">
                <div class="feature-panel-header">
                    <div class="feature-panel-title">Stickers</div>
                    <button class="feature-panel-close-btn" data-panel="stickerPanel">×</button>
                </div>
                <div class="feature-panel-content">
                    <input type="text" id="sticker-search-input" class="feature-search-bar" placeholder="Search stickers...">
                    <div id="stickerGrid"></div>
                </div>
            </div>

            <!-- Audio Panel -->
            <div id="audioPanel" class="feature-panel">
                <div class="feature-panel-header">
                    <div class="feature-panel-title">Audio</div>
                    <button class="feature-panel-close-btn" data-panel="audioPanel">×</button>
                </div>
                <div class="feature-panel-content">
                    <input type="text" class="feature-search-bar" placeholder="Search sounds...">
                    <ul id="audioList"></ul>
                </div>
            </div>

            <!-- GIF Panel -->
            <div id="gifPanel" class="feature-panel">
                 <div class="feature-panel-header">
                    <div class="feature-panel-title">GIFs</div>
                    <button class="feature-panel-close-btn" data-panel="gifPanel">×</button>
                </div>
                <div class="feature-panel-content">
                    <input type="text" id="gif-search-input" class="feature-search-bar" placeholder="Search for GIFs...">
                    <div id="gif-results-grid"></div>
                </div>
            </div>

            <!-- Expandable Options Menu -->
            <div id="expandOptions" class="expand-options">
                <button class="expand-option-btn" id="gifOptionBtn"><span class="icon">📄</span> GIF</button>
                <button class="expand-option-btn" id="audioOptionBtn"><span class="icon">🎵</span> Audio</button>
                <button class="expand-option-btn" id="stickerOptionBtn"><span class="icon">😊</span> Sticker</button>
            </div>

            <!-- Main Input Row -->
            <div class="input-row">
                <button class="expand-btn" id="expandBtn">+</button>
                <input type="text" class="message-input" id="messageInput" placeholder="Type a message..." autocomplete="off">
                <button class="send-button" id="sendButton">➤</button>
            </div>
        </div>
      </div>

      <!-- Find Menu View -->
      <div id="findMenuView" class="view find-view hidden">
        <div class="chat-header">
          <button class="back-button" id="findMenuBackBtn">←</button>
          <div class="chat-header-info">
              <div class="header-app-name">Find Users</div>
          </div>
        </div>
        <div style="padding: 24px;">
            <h2>Find Connections</h2>
            <p>Discover new people on Gappkar</p>
            <button class="find-menu-btn primary" id="findAccountsBtn">
                <span>👤</span> Find Accounts
            </button>
            <button class="find-menu-btn" id="nearbyBtn">
                <span>📍</span> Nearby
            </button>
        </div>
      </div>

      <!-- Nearby Users View -->
      <div id="nearbyView" class="view find-view hidden">
        <div class="chat-header">
          <button class="back-button" id="nearbyBackBtn">←</button>
          <div class="chat-header-info">
              <div class="header-app-name">Nearby Users</div>
          </div>
        </div>
        <div style="padding: 24px;">
            <div class="screen-header">
                <h2>Nearby Recommendations</h2>
            </div>
            <input type="text" class="search-bar" id="nearbySearchInput" placeholder="Filter by name...">
            <ul class="user-list" id="nearbyUserList">
                <!-- JS will populate this list -->
            </ul>
        </div>
      </div>

      <!-- Search Accounts View -->
      <div id="searchView" class="view find-view hidden">
        <div class="chat-header">
          <button class="back-button" id="searchBackBtn">←</button>
          <div class="chat-header-info">
              <div class="header-app-name">Search Accounts</div>
          </div>
        </div>
        <div style="padding: 24px;">
             <div class="screen-header">
                <h2>Search Accounts</h2>
            </div>
            <input type="text" class="search-bar" id="accountSearchInput" placeholder="Search by name or location...">
            <ul class="user-list" id="userResultsList">
                <!-- JS will populate this list -->
            </ul>
        </div>
      </div>
    </div>
  </div>
  
  <div class="room-modal" id="roomModal">
    <div class="room-modal-content">
      <button class="room-modal-close" id="roomModalClose">×</button>
      <div class="room-modal-header">
        <h3 class="room-modal-title">Room Manager</h3>
        <p class="room-modal-description">Create or join a private room</p>
      </div>
      <div class="form-group">
        <label class="form-label" for="roomKeyInput">Room Key</label>
        <input type="text" id="roomKeyInput" class="form-input" placeholder="Enter room key (e.g., myroom123)" maxlength="50">
      </div>
      <div class="room-buttons">
        <button class="btn-room" id="joinRoomBtn">Join Room</button>
        <button class="btn-room primary" id="createRoomBtnModal">Create Room</button>
      </div>
      <div class="room-buttons" style="margin-top: 10px;">
        <button class="btn-room" id="leaveRoomBtn" style="width: 100%;">Leave Current Room</button>
      </div>
    </div>
  </div>

  <!-- Mobile Keyboard Handling Script -->
  <script>
    // Mobile keyboard handling
    function setupMobileKeyboardHandling() {
      if (!('ontouchstart' in window)) return; // Not a mobile device
      const messageInput = document.getElementById('messageInput');
      const messageList = document.getElementById('messageList');
      const chatInputArea = document.querySelector('.chat-input-area');
      let initialViewportHeight = window.innerHeight;
      
      function handleKeyboardShow() {
        document.body.classList.add('keyboard-visible');
        setTimeout(() => {
          if (messageList) {
            messageList.scrollTop = messageList.scrollHeight;
          }
        }, 300);
      }
      
      function handleKeyboardHide() {
        document.body.classList.remove('keyboard-visible');
      }
      
      // iOS handling
      if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        messageInput.addEventListener('focus', () => {
          setTimeout(handleKeyboardShow, 300);
        });
        messageInput.addEventListener('blur', () => {
          setTimeout(handleKeyboardHide, 100);
        });
        
        // Viewport height change detection for iOS
        window.addEventListener('resize', () => {
          const currentHeight = window.innerHeight;
          if (currentHeight < initialViewportHeight * 0.7) {
            handleKeyboardShow();
          } else if (currentHeight > initialViewportHeight * 0.9) {
            handleKeyboardHide();
            initialViewportHeight = currentHeight;
          }
        });
      }
      // Android handling
      else {
        let lastHeight = window.innerHeight;
        const resizeObserver = new ResizeObserver(() => {
          const currentHeight = window.innerHeight;
          const heightDiff = lastHeight - currentHeight;
          if (heightDiff > 150) { // Keyboard likely opened
            handleKeyboardShow();
          } else if (heightDiff < -150) { // Keyboard likely closed
            handleKeyboardHide();
          }
          lastHeight = currentHeight;
        });
        resizeObserver.observe(document.body);
      }
      
      // Enhanced scroll behavior for new messages
      window.scrollBottom = () => {
        if (messageList) {
          messageList.scrollTop = messageList.scrollHeight;
          // Extra scroll for mobile keyboard
          if (document.body.classList.contains('keyboard-visible')) {
            setTimeout(() => {
              messageList.scrollTop = messageList.scrollHeight;
            }, 100);
          }
        }
      };
    }
    
    // Initialize when DOM is loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupMobileKeyboardHandling);
    } else {
      setupMobileKeyboardHandling();
    }
  </script>

  <!-- Main Firebase Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, addDoc, collection, doc, setDoc, onSnapshot, orderBy, query, serverTimestamp, deleteDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyCOmLxxqPesNaBr4Z9fVIU6K2BLW6OsED0",
      authDomain: "gappkar-v1-b3afe.firebaseapp.com",
      databaseURL: "https://gappkar-v1-b3afe-default-rtdb.firebaseio.com",
      projectId: "gappkar-v1-b3afe",
      storageBucket: "gappkar-v1-b3afe.appspot.com",
      messagingSenderId: "726018257415",
      appId: "1:726018257415:web:12142708abdf47952af0a2",
      measurementId: "G-EWK4436NRB"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    let currentUser = null, currentUsername = "", currentUserAge = 0, currentUserLocation = "";
    let userLatitude = null, userLongitude = null, isJoined = false, currentRoom = "global";
    let messagesListener = null, presenceTimer = null, onlineListener = null;
    let currentView = 'joinView';
    
    const $ = id => document.getElementById(id);
    const allViews = document.querySelectorAll('.view');
    const joinView = $("joinView"), chatsView = $("chatsView"), messageList = $("messageList");
    const messageInput = $("messageInput"), sendButton = $("sendButton"), backButton = $("backButton");
    const usernameInput = $("usernameInput"), ageInput = $("ageInput"), locationInput = $("locationInput");
    const joinButton = $("joinButton"), getLocationBtn = $("getLocationBtn"), peopleCount = $("peopleCount");
    const createRoomBtnH = $("createRoomBtn"), roomModal = $("roomModal"), roomModalClose = $("roomModalClose");
    const roomKeyInput = $("roomKeyInput"), joinRoomBtn = $("joinRoomBtn"), createRoomBtnM = $("createRoomBtnModal");
    const leaveRoomBtn = $("leaveRoomBtn"), roomIndicator = $("roomIndicator");

    // Find/Search Elements
    const findBtn = $("findBtn");
    const findAccountsBtn = $("findAccountsBtn");
    const nearbyBtn = $("nearbyBtn");
    const nearbyUserList = $("nearbyUserList");
    const userResultsList = $("userResultsList");
    const accountSearchInput = $("accountSearchInput");
    const nearbySearchInput = $("nearbySearchInput");

    // ✅ NEW: Enhanced Chat Input Elements
    const expandBtn = $('expandBtn');
    const expandOptions = $('expandOptions');
    const gifOptionBtn = $('gifOptionBtn');
    const audioOptionBtn = $('audioOptionBtn');
    const stickerOptionBtn = $('stickerOptionBtn');
    const stickerPanel = $('stickerPanel');
    const audioPanel = $('audioPanel');
    const gifPanel = $('gifPanel');
    const allFeaturePanels = [stickerPanel, audioPanel, gifPanel];
    let currentAudio = null; // To manage audio playback
    
    const roomMessagesRef = room => collection(db, "rooms", room, "messages");
    
    const timeStr = ts => {
      const d = ts?.toDate ? ts.toDate() : (ts || new Date());
      let h = d.getHours();
      const m = d.getMinutes().toString().padStart(2, "0");
      const a = h >= 12 ? "PM" : "AM";
      h = h % 12 || 12;
      return `${h}:${m} ${a}`;
    };
    
    const scrollBottom = () => {
      if (messageList) {
        messageList.scrollTop = messageList.scrollHeight;
        // Enhanced mobile scrolling
        if (window.innerWidth <= 480 && document.body.classList.contains('keyboard-visible')) {
          setTimeout(() => {
            messageList.scrollTop = messageList.scrollHeight;
          }, 100);
        }
      }
    };

    // View Management
    function showView(viewId) {
      currentView = viewId;
      allViews.forEach(v => v.classList.add('hidden'));
      $(viewId)?.classList.remove('hidden');
      
      // Only show app header for join view
      const appHeader = document.querySelector('.app-header');
      if (appHeader) {
        appHeader.style.display = viewId === 'joinView' ? 'block' : 'none';
      }
    }
    
    const updateRoomUI = () => {
      if (!roomIndicator) return;
      roomIndicator.textContent = currentRoom === "global" ? "Global" : currentRoom;
      roomIndicator.style.background = currentRoom === "global" ? "var(--accent)" : "#28a745";
    };
    
    const addSystemMsg = txt => {
      const div = document.createElement("div");
      div.className = "message system";
      div.innerHTML = `<div class="message-bubble">${txt}</div>`;
      messageList.appendChild(div);
      scrollBottom();
    };
    
    function trackPresence() {
      if (!currentUser || !currentUsername) return;
      const ref = doc(db, "presence", currentUser.uid);
      const data = {
        userId: currentUser.uid, username: currentUsername, location: currentUserLocation,
        age: currentUserAge, room: currentRoom, lastSeen: serverTimestamp(), isOnline: true
      };
      setDoc(ref, data, { merge: true });
      clearInterval(presenceTimer);
      presenceTimer = setInterval(() => setDoc(ref, { room: currentRoom, lastSeen: serverTimestamp() }, { merge: true }), 30000);
    }
    
    function listenOnlineUsers() {
      onlineListener && onlineListener();
      onlineListener = onSnapshot(collection(db, "presence"), snap => {
        const fiveAgo = Date.now() - 5 * 60 * 1000;
        let roomCnt = 0;
        snap.forEach(doc => {
          const d = doc.data();
          if (d.lastSeen?.toDate && d.lastSeen.toDate().getTime() > fiveAgo && d.room === currentRoom) roomCnt++;
        });
        peopleCount.textContent = `${roomCnt} people ${currentRoom === "global" ? "nearby" : "in " + currentRoom}`;
      });
    }

    // Find/Search Logic
    function createUserCard(user) {
      if (user.userId === currentUser?.uid) return '';
      return `
          <li class="user-card">
              <img src="https://i.pravatar.cc/150?u=${user.userId}" alt="${user.username}" class="profile-pic">
              <div class="user-info">
                  <h3>${user.username} (${user.age})</h3>
                  <p>📍 ${user.location || 'Unknown'}</p>
              </div>
          </li>
      `;
    }

    function renderUserList(targetList, users) {
      if (!users || users.length === 0) {
          targetList.innerHTML = '<p style="text-align:center; color: var(--gray); padding: 20px;">No users found.</p>';
          return;
      }
      targetList.innerHTML = users.filter(u => u.userId !== currentUser?.uid).map(createUserCard).join('');
    }

    async function fetchAllOnlineUsers() {
      const fiveAgo = new Date(Date.now() - 5 * 60 * 1000);
      const q = query(collection(db, "presence"), where("lastSeen", ">", fiveAgo));
      try {
          const snapshot = await getDocs(q);
          return snapshot.docs.map(doc => doc.data());
      } catch (error) {
          console.error("Error fetching users:", error);
          return [];
      }
    }

    // ✅ NEW: Enhanced Multimedia Message Function  
    async function sendMultimediaMessage(content, type) {
      if (!isJoined) return;
      
      try {
        const messageData = {
          user: currentUsername, 
          timestamp: serverTimestamp(),
          location: currentUserLocation, 
          age: currentUserAge, 
          userId: currentUser.uid
        };

        switch(type) {
          case 'gif':
            messageData.message = '[GIF]';
            messageData.gifUrl = content;
            messageData.isGif = true;
            break;
          case 'sticker':
            messageData.message = '[Sticker]';
            messageData.stickerUrl = content;
            messageData.isSticker = true;
            break;
          case 'audio':
            messageData.message = `[Audio] ${content.name}`;
            messageData.audioUrl = content.url;
            messageData.audioName = content.name;
            messageData.isAudio = true;
            break;
        }

        await addDoc(roomMessagesRef(currentRoom), messageData);
      } catch (e) {
        console.error("Failed to send multimedia:", e);
        addSystemMsg('Failed to send message');
      }
    }
    
    async function getUserLocation() {
      const statusDiv = $("locationStatus");
      if (!navigator.geolocation) {
        statusDiv.textContent = "Geolocation is not supported."; statusDiv.className = "error"; return;
      }
      statusDiv.textContent = "Getting your location..."; statusDiv.className = "";
      try {
        const position = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 }));
        userLatitude = position.coords.latitude; userLongitude = position.coords.longitude;
        const locationName = await (async (lat, lon) => { try { const r = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`); return (await r.json()).city; } catch (e) { return null; } })(userLatitude, userLongitude);
        currentUserLocation = locationName || `${userLatitude.toFixed(2)}, ${userLongitude.toFixed(2)}`;
        statusDiv.textContent = `Location found: ${currentUserLocation}`; statusDiv.className = "success";
        locationInput.value = currentUserLocation;
      } catch (error) {
        statusDiv.textContent = "Could not get location. Enter manually."; statusDiv.className = "error";
      }
    }
    
    function showModal() { roomModal.classList.add("show"); }
    function hideModal() { roomModal.classList.remove("show"); roomKeyInput.value = ""; }
    
    async function joinRoom(key) {
      const k = key.trim().toLowerCase();
      if (!k) return alert("Enter a room key");
      if (k === currentRoom) return hideModal();
      messagesListener && messagesListener();
      currentRoom = k;
      localStorage.setItem("gappkar_current_room", currentRoom);
      updateRoomUI(); messageList.innerHTML = "";
      addSystemMsg(`Joined room: ${currentRoom}`);
      listenMessages(); trackPresence(); hideModal();
    }
    
    function leaveRoom() {
      if (currentRoom === "global") return hideModal();
      messagesListener && messagesListener();
      currentRoom = "global";
      localStorage.removeItem("gappkar_current_room");
      updateRoomUI(); messageList.innerHTML = "";
      addSystemMsg("Left room, back to global chat");
      listenMessages(); trackPresence(); hideModal();
    }
    
    function displayMsg(d) {
      const mine = d.user === currentUsername;
      const div = document.createElement("div");
      div.className = `message ${mine ? "sent" : "received"}`;
      const time = timeStr(d.timestamp);

      let messageContent = '';

      // Handle different message types
      if (d.isGif && d.gifUrl) {
        messageContent = `<img src="${d.gifUrl}" style="max-width: 250px; border-radius: 16px;">`;
      } else if (d.isSticker && d.stickerUrl) {
        messageContent = `<img src="${d.stickerUrl}" style="max-width: 150px; border-radius: 16px;">`;
      } else if (d.isAudio && d.audioUrl) {
        messageContent = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <button class="chat-audio-play-btn" data-src="${d.audioUrl}">▶</button>
            <span>${d.audioName || 'Audio'}</span>
          </div>
        `;
      } else {
        messageContent = d.message;
      }

      div.innerHTML = mine
        ? `<div class="message-bubble">${messageContent}<div class="message-time">${time}</div></div>`
        : `<div class="message-info"><div class="sender-name">${d.user}${d.age ? ` (${d.age})` : ""}</div><div class="message-bubble">${messageContent}<div class="message-time">${time}</div></div>${d.location ? `<div class="message-location">📍 ${d.location}</div>` : ""}</div>`;
      
      messageList.appendChild(div);
    }
    
    function listenMessages() {
      messagesListener && messagesListener();
      const q = query(roomMessagesRef(currentRoom), orderBy("timestamp", "asc"));
      messagesListener = onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          if (change.type === "added") {
            const temp = messageList.querySelector('[data-temp="true"]');
            if (temp) temp.remove();
            displayMsg(change.doc.data());
          }
        });
        scrollBottom();
      });
    }

    // ✅ FIXED: Original sendMessage function (for text messages)
    async function sendMessage() {
      const txt = messageInput.value.trim();
      if (!txt || !isJoined) return;
      messageInput.value = "";
      const tempId = `temp_${Date.now()}`;
      const div = document.createElement("div");
      div.className = "message sent";
      div.id = tempId;
      div.dataset.temp = "true";
      div.innerHTML = `<div class="message-bubble">${txt}<div class="message-time" style="opacity: 0.5;">sending...</div></div>`;
      messageList.appendChild(div);
      scrollBottom();
      try {
        await addDoc(roomMessagesRef(currentRoom), {
          user: currentUsername, message: txt, timestamp: serverTimestamp(),
          location: currentUserLocation, age: currentUserAge, userId: currentUser.uid
        });
      } catch (e) {
        console.error("Send failed:", e);
        const failedNode = document.getElementById(tempId);
        if (failedNode) {
          failedNode.querySelector('.message-bubble').style.backgroundColor = '#d32f2f';
          failedNode.querySelector('.message-time').innerText = 'Failed to send!';
        }
      }
    }
    
    async function joinChat(name, age, loc) {
      if (!name.trim()) return alert("Enter name");
      if (age < 13 || age > 99) return alert("Age 13-99 only");
      if (!loc.trim()) return alert("Enter location");
      if (isJoined) return;
      await signInAnonymously(auth);
      currentUsername = name.trim();
      currentUserAge = parseInt(age, 10);
      currentUserLocation = loc.trim();
      isJoined = true;
      const savedRoom = localStorage.getItem("gappkar_current_room");
      if (savedRoom) currentRoom = savedRoom;
      showView('chatsView');
      document.body.classList.add("chat-active");
      updateRoomUI();
      messageList.innerHTML = "";
      addSystemMsg(`Welcome ${currentUsername}!`);
      listenMessages(); trackPresence(); listenOnlineUsers();
      localStorage.setItem("gappkar_username", currentUsername);
      localStorage.setItem("gappkar_age", currentUserAge);
      localStorage.setItem("gappkar_location", currentUserLocation);
      localStorage.setItem("gappkar_joined", "true");
    }
    
    onAuthStateChanged(auth, u => currentUser = u || null);
    
    async function logout() {
      presenceTimer && clearInterval(presenceTimer);
      onlineListener && onlineListener();
      messagesListener && messagesListener();
      if (currentUser) {
        try { await deleteDoc(doc(db, "presence", currentUser.uid)); } catch(e) { console.error("Presence cleanup failed:", e) }
      }
      try { await signOut(auth); } catch {}
      isJoined = false; currentRoom = "global";
      localStorage.clear();
      showView('joinView');
      document.body.classList.remove("chat-active");
    }

    // Navigation functions
    function handleMainBack() {
      if (['findMenuView', 'nearbyView', 'searchView'].includes(currentView)) {
        showView('chatsView');
      } else {
        logout();
      }
    }

    function handleFindBack() {
      showView('chatsView');
    }

    // ✅ NEW: Enhanced Chat Input Logic
   const sounds = [
    { name: 'Aand Bhat Khaoge', url: 'https://file.garden/aJ-bbmBvGxKiA5vP/Aand%20Bhat%20Khaoge%20Memes%20_%20%E0%A4%86%E0%A4%82%E0%A4%A1%20%E0%A4%AD%E0%A4%BE%E0%A4%A4%20%E0%A4%96%E0%A4%BE%E0%A4%93%E0%A4%97%E0%A5%87%20%E0%A4%AE%E0%A5%80%E0%A4%AE%20_%20Meme%20Centre(MP3_160K).mp3' },
    { name: 'Deepak Kalal Foundation', url: 'https://file.garden/aJ-bbmBvGxKiA5vP/Deepak%20kalal%20foundation' },
    { name: 'Thala Ajithkumar', url: 'https://file.garden/aJ-bbmBvGxKiA5vP/Thala%20Ajithkumar.mp3' },
    { name: 'Rajinikanth Updating', url: 'https://file.garden/aJ-bbmBvGxKiA5vP/Rajinikanth%20updating.mp3' },
    { name: 'Modern Bell', url: 'https://file.garden/aJ-bbmBvGxKiA5vP/modern%20Bell.mp3' },
    { name: 'Insuperable Del Risita', url: 'https://file.garden/aJ-bbmBvGxKiA5vP/insuperable%20del%20Risita.mp3' },
    { name: 'Notification', url: '' },
    { name: 'Success', url: '' },
    { name: 'Error', url: '' },

    ];

    const togglePanel = (panelToShow) => {
        const isVisible = panelToShow.classList.contains('visible');
        allFeaturePanels.forEach(p => p.classList.remove('visible'));
        if (!isVisible) {
            panelToShow.classList.add('visible');
        }
    };

    // Setup Audio List
    const audioList = $('audioList');
    sounds.forEach(sound => {
        const li = document.createElement('li');
        li.className = 'audio-item';
        li.innerHTML = `<button class="play-btn">▶</button><span class="audio-name">${sound.name}</span>`;
        li.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') {
                sendMultimediaMessage(sound, 'audio');
                togglePanel(audioPanel);
            }
        });
        li.querySelector('.play-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            if (sound.url) {
                currentAudio = new Audio(sound.url);
                currentAudio.play();
            }
        });
        audioList.appendChild(li);
    });

    // ✅ FIXED: Giphy API Logic
    const GIPHY_API_KEY = 'GLutXRXDEL19PuG3ztekK0JNDr5oySTh';
    let debounceTimer;

    function setupGiphyPanel(type, searchInputId, resultsGridId) {
        const searchInput = $(searchInputId);
        const resultsGrid = $(resultsGridId);
        const endpoint = type === 'stickers' ? 'stickers' : 'gifs';

        async function fetchItems(searchTerm = '') {
            resultsGrid.innerHTML = '<div>Loading...</div>';
            const url = searchTerm ?
                `https://api.giphy.com/v1/${endpoint}/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(searchTerm)}&limit=24` :
                `https://api.giphy.com/v1/${endpoint}/trending?api_key=${GIPHY_API_KEY}&limit=24`;
            try {
                const res = await fetch(url);
                const { data } = await res.json();
                resultsGrid.innerHTML = '';
                data.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = type === 'stickers' ? 'sticker-item' : 'gif-item';
                    itemEl.innerHTML = `<img src="${item.images.fixed_width.url}" alt="${item.title}">`;
                    itemEl.onclick = () => {
                        sendMultimediaMessage(item.images.original.url, type === 'stickers' ? 'sticker' : 'gif');
                        togglePanel($(type === 'stickers' ? 'stickerPanel' : 'gifPanel'));
                    };
                    resultsGrid.appendChild(itemEl);
                });
            } catch (e) {
                resultsGrid.innerHTML = `<div>Failed to load ${type}.</div>`;
            }
        }

        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => fetchItems(searchInput.value), 500);
        });
        
        fetchItems(); // Initial fetch for trending items
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem("gappkar_joined") === "true") {
        joinChat(localStorage.getItem("gappkar_username") || "", localStorage.getItem("gappkar_age") || 0, localStorage.getItem("gappkar_location") || "");
      }
      
      // ✅ ORIGINAL: Core event listeners
      getLocationBtn.addEventListener("click", getUserLocation);
      joinButton.addEventListener("click", () => joinChat(usernameInput.value, ageInput.value, locationInput.value));
      sendButton.addEventListener("click", sendMessage);
      messageInput.addEventListener("keydown", e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
      backButton.addEventListener("click", handleMainBack);
      createRoomBtnH.addEventListener("click", showModal);
      roomModalClose.addEventListener("click", hideModal);
      joinRoomBtn.addEventListener("click", () => joinRoom(roomKeyInput.value));
      createRoomBtnM.addEventListener("click", () => joinRoom(roomKeyInput.value));
      leaveRoomBtn.addEventListener("click", leaveRoom);
      roomModal.addEventListener("click", e => { if (e.target === roomModal) hideModal(); });

      // ✅ ORIGINAL: Find/Search Event Listeners
      findBtn.addEventListener('click', () => showView('findMenuView'));
      $("findMenuBackBtn").addEventListener("click", handleFindBack);
      $("nearbyBackBtn").addEventListener("click", () => showView('findMenuView'));
      $("searchBackBtn").addEventListener("click", () => showView('findMenuView'));

      nearbyBtn.addEventListener('click', async () => {
        showView('nearbyView');
        nearbyUserList.innerHTML = '<p style="text-align:center; color: var(--gray); padding: 20px;">Loading users...</p>';
        const allOnlineUsers = await fetchAllOnlineUsers();
        const nearbyUsers = allOnlineUsers.filter(u => u.location.toLowerCase() === currentUserLocation.toLowerCase());
        renderUserList(nearbyUserList, nearbyUsers.length > 1 ? nearbyUsers : allOnlineUsers);
      });

      findAccountsBtn.addEventListener('click', () => {
        showView('searchView');
        renderUserList(userResultsList, []);
      });

      accountSearchInput.addEventListener('input', async (e) => {
        const searchTerm = e.target.value.toLowerCase();
        if (!searchTerm) {
          renderUserList(userResultsList, []);
          return;
        }
        const allOnlineUsers = await fetchAllOnlineUsers();
        const results = allOnlineUsers.filter(user => 
          user.username.toLowerCase().includes(searchTerm) ||
          user.location.toLowerCase().includes(searchTerm)
        );
        renderUserList(userResultsList, results);
      });

      // ✅ NEW: Enhanced Chat Input Event Listeners
      expandBtn.addEventListener('click', () => {
          expandBtn.classList.toggle('active');
          expandOptions.classList.toggle('visible');
          if (!expandOptions.classList.contains('visible')) {
              allFeaturePanels.forEach(p => p.classList.remove('visible'));
          }
      });

      const setupOptionButton = (btn, panel) => {
          btn.addEventListener('click', () => {
               togglePanel(panel);
               expandOptions.classList.remove('visible');
               expandBtn.classList.remove('active');
          });
      };

      setupOptionButton(stickerOptionBtn, stickerPanel);
      setupOptionButton(audioOptionBtn, audioPanel);
      setupOptionButton(gifOptionBtn, gifPanel);

      document.querySelectorAll('.feature-panel-close-btn').forEach(btn => {
          btn.addEventListener('click', () => {
              const panelId = btn.getAttribute('data-panel');
              $(panelId).classList.remove('visible');
          });
      });

      // Audio play button handler
      messageList.addEventListener('click', (e) => {
          if (e.target.classList.contains('chat-audio-play-btn')) {
              const audioSrc = e.target.dataset.src;
              if (audioSrc) {
                  if (currentAudio) {
                      currentAudio.pause();
                  }
                  currentAudio = new Audio(audioSrc);
                  currentAudio.play();
              }
          }
      });

      // ✅ Setup Giphy panels
      setupGiphyPanel('gifs', 'gif-search-input', 'gif-results-grid');
      setupGiphyPanel('stickers', 'sticker-search-input', 'stickerGrid');
    });
  </script>

  <!-- Theme Toggle Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = document.getElementById('themeIcon');
      
      function toggleTheme() {
        const body = document.body;
        if (body.getAttribute('data-theme') === 'dark') {
          body.removeAttribute('data-theme');
          if (themeIcon) themeIcon.textContent = '🌙';
        } else {
          body.setAttribute('data-theme', 'dark');
          if (themeIcon) themeIcon.textContent = '☀️';
        }
      }
      
      if (themeToggle) { 
        themeToggle.addEventListener('click', toggleTheme); 
      }
    });
  </script>
</body>
</html>
